<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆUI Demo (v15 - ç®¡ç†å‘˜æ¨¡å¼å…¥å£)</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative; /* ä¸ºè¦†ç›–å±‚å®šä½æä¾›åŸºç¡€ */
        }
        /* èœå•æ æ ·å¼ */
        .top-menu-bar {
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 40;
        }
        .menu-left { /* æ–°å¢ï¼šç”¨äºåŒ…è£¹å·¦ä¾§æ ‡é¢˜å’Œä¸–ç•Œé€‰æ‹© */
            display: flex;
            align-items: center;
            gap: 1.5rem; /* æ ‡é¢˜å’Œä¸–ç•Œé€‰æ‹©ä¹‹é—´çš„é—´è· */
        }
        .menu-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
        }
        .settings-dropdown {
            position: relative;
        }
        .settings-button {
            background-color: transparent;
            border: none;
            color: #4b5563;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .settings-button:hover {
            background-color: #e5e7eb;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.1);
            z-index: 50; /* æ¯”èœå•æ é«˜ */
            border-radius: 0.375rem;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        .dropdown-content a {
            color: #374151;
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }
        .dropdown-content a:hover {
            background-color: #f3f4f6;
        }
        .dropdown-content.show {
            display: block;
        }

        /* ä¸»å®¹å™¨æ ·å¼ */
        .main-container {
            display: flex;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        .module {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .module-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            color: #111827;
        }
        .module-content {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f3f4f6;
             position: relative;
             z-index: 1;
        }
        .module-content::-webkit-scrollbar { width: 6px; }
        .module-content::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 3px; }
        .module-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        /* --- çœç•¥å…¶ä»–æœªä¿®æ”¹çš„æ ·å¼ --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn:hover { filter: brightness(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .btn:active { transform: scale(0.98); filter: brightness(0.95); }
        .btn-primary { background-color: #60a5fa; color: white; border-color: #3b82f6; }
        .btn-secondary { background-color: #9ca3af; color: white; border-color: #6b7280; }
        .btn-danger { background-color: #f87171; color: white; border-color: #ef4444; }
        .btn-warning { background-color: #fbbf24; color: #422006; border-color: #f59e0b; }
        .btn-success { background-color: #4ade80; color: #064e3b; border-color: #22c55e; }
        .btn-info { background-color: #67e8f9; color: #0e7490; border-color: #22d3ee; }
        .btn-blue { background-color: #60a5fa; color: white; border-color: #3b82f6; }
        .btn-outline { background-color: transparent; border-color: currentColor; }
        .btn-outline-gray { color: #4b5563; border-color: #d1d5db; }
        .btn-outline-gray:hover { background-color: #f3f4f6; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

        .bar-label-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .bar-label { font-size: 0.875rem; font-weight: 500; width: 4rem; flex-shrink: 0; }
        .bar-label-hp { color: #dc2626; }
        .bar-label-mp { color: #2563eb; }
        .progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; position: relative; flex-grow: 1; }
        .progress-bar { height: 100%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        .progress-bar-hp { background-color: #ef4444; }
        .progress-bar-mp { background-color: #3b82f6; }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.25rem 0; position: relative; z-index: 2; background-color: #fff; }
        .collapsible-header:hover { background-color: #f9fafb; }
        .collapsible-title { font-size: 0.875rem; font-semibold: 500; color: #4b5563; }
        .collapsible-summary { font-size: 0.8rem; color: #6b7280; flex-grow: 1; text-align: right; margin-right: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .collapsible-icon { transition: transform 0.3s ease; color: #9ca3af; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; position: relative; z-index: 1; }
        .collapsible-content.expanded { max-height: 1000px; transition: max-height 0.5s ease-in; overflow: visible; }
        .collapsible-header.expanded .collapsible-icon { transform: rotate(90deg); }

        #status-section .collapsible-header { cursor: default; }
        #status-section .collapsible-header:hover { background-color: transparent; }
        #status-section .collapsible-icon { display: none; }
        #status-section #status-content { max-height: none; overflow: visible; }


        .stat-item { background-color: #f9fafb; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; font-size: 0.875rem; display: flex; justify-content: space-between; align-items: center; }
        .stat-label { color: #6b7280; }
        .stat-value { font-weight: 600; color: #1f2937; }

        .attr-adjust-btn { background-color: #d1d5db; border: none; color: #374151; padding: 0 0.3rem; border-radius: 0.25rem; cursor: pointer; font-weight: bold; font-size: 0.8rem; line-height: 1; margin: 0 0.2rem; }
        .attr-adjust-btn:hover { background-color: #9ca3af; }

        .item-display { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 0.25rem; border-radius: 0.25rem; }
        .item-icon { width: 3rem; height: 3rem; background-color: #e5e7eb; border: 1px solid #d1d5db; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: #6b7280; position: relative; margin-bottom: 0.25rem; }
        .item-icon:hover { background-color: #d1d5db; }
        .item-name { font-size: 0.75rem; color: #4b5563; line-height: 1.2; max-width: 3.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-count { position: absolute; bottom: -2px; right: -2px; background-color: rgba(0, 0, 0, 0.6); color: white; font-size: 0.7rem; padding: 0 4px; border-radius: 4px; }

        .status-item { display: inline-block; margin-right: 1rem; margin-bottom: 0.25rem; position: relative; z-index: 10; }
        .status-text { font-medium: 500; text-sm: 0.875rem; cursor: default; }
        .status-positive { color: #1d4ed8; }
        .status-positive-alt { color: #059669; }
        .status-negative { color: #dc2626; }

        .equipment-item { position: relative; }
        .equipment-item .stat-item { cursor: default; }

        .map-tile { width: 100%; aspect-ratio: 1 / 1; border: 1px solid #d1d5db; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1.25rem; position: relative; background-color: #e2f0d9; color: #548235; }
        .map-tile:hover { background-color: #c9e4b8; transform: scale(1.05); }
        .map-tile.player-location { box-shadow: 0 0 0 3px #fbbf24 inset; z-index: 10; }
        .map-tile.player-location::after { content: 'ğŸ‘¤'; position: absolute; font-size: 1.5rem; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; /* æé«˜å¼¹çª—å±‚çº§ */ opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-container { background-color: #ffffff; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 1.5rem 2rem; max-width: 90%; max-height: 90vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-container { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 1rem; background: none; border: none; font-size: 1.75rem; color: #9ca3af; cursor: pointer; padding: 0; line-height: 1; z-index: 110; }
        .modal-close-btn:hover { color: #6b7280; }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #111827; }

        /* ç‰¹å®šå¼¹çª—å°ºå¯¸ */
        .modal-details { max-width: 600px; }
        .modal-synthesis { max-width: 1100px; width: 85vw; }
        .modal-battle { max-width: 1000px; width: 80vw; }
        .modal-admin { max-width: 400px; } /* æ–°å¢ï¼šç®¡ç†å‘˜æ¨¡å¼å¼¹çª—å°ºå¯¸ */

        /* åˆæˆå¼¹çª—æ ·å¼ */
        .synthesis-modal-layout { display: flex; gap: 1rem; min-height: 60vh; }
        .synthesis-column { flex: 1; display: flex; flex-direction: column; background-color: #f9fafb; padding: 1rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; overflow: visible; }
        #synthesis-inventory-list-container { flex-grow: 1; overflow-y: auto; position: relative; z-index: 1; }
        #synthesis-inventory-list.icon-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(5rem, 1fr)); gap: 1rem; padding: 0.5rem; }
        #synthesis-inventory-list.list-view { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; }
        #synthesis-inventory-list.list-view .item-display { flex-direction: row; justify-content: space-between; align-items: center; text-align: left; padding: 0.5rem; background-color: #fff; border: 1px solid #e5e7eb; }
        #synthesis-inventory-list.list-view .item-icon { width: 2rem; height: 2rem; font-size: 1rem; margin-bottom: 0; margin-right: 0.5rem; }
        #synthesis-inventory-list.list-view .item-name { flex-grow: 1; max-width: none; white-space: normal; }
        #synthesis-inventory-list.list-view .item-count { position: static; background: none; color: #6b7280; font-size: 0.8rem; padding: 0; border-radius: 0; margin-left: 0.5rem; }
        #synthesis-inventory-list .tooltip .tooltiptext { bottom: auto; top: 100%; left: 0; transform: none; margin-top: 4px; z-index: 9999; }
        #synthesis-inventory-list .tooltip .tooltiptext::after { content: none; }
        .synthesis-area { border: 2px dashed #cbd5e1; min-height: 150px; border-radius: 0.5rem; background-color: #ffffff; padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-content: flex-start; margin-bottom: 1rem; }
        .synthesis-item-icon { width: 3.5rem; height: 3.5rem; }
        .formula-list { flex-grow: 1; overflow-y: auto; }
        .formula-item { background-color: #ffffff; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.8rem; border: 1px solid #e5e7eb; }

        /* æˆ˜æ–—å¼¹çª—æ ·å¼ */
        .battle-modal-layout { display: flex; gap: 1rem; max-height: 80vh; }
        .battle-left-column { width: 35%; display: flex; flex-direction: column; gap: 1rem; }
        .battle-right-column { width: 65%; display: flex; flex-direction: column; overflow: hidden; }
        .battle-area { background-color: #f9fafb; padding: 1rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
        .battle-log { flex-grow: 1; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; font-size: 0.875rem; overflow-y: auto; margin-bottom: 1rem; background-color: #ffffff; max-height: 400px; min-height: 150px; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f3f4f6; }
        .battle-log::-webkit-scrollbar { width: 6px; }
        .battle-log::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 3px; }
        .battle-log::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .battle-log p { margin-bottom: 0.5rem; }
        .battle-log .log-player { color: #2563eb; }
        .battle-log .log-enemy { color: #dc2626; }
        .battle-log .log-system { color: #6b7280; font-style: italic; }
        .battle-unit { display: flex; align-items: center; gap: 1rem; }
        .battle-unit-avatar { width: 4rem; height: 4rem; background-color: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6b7280; flex-shrink: 0; cursor: pointer; }
        .battle-unit-avatar:hover { filter: brightness(0.95); }
        .battle-unit-info { flex-grow: 1; }
        .battle-skills { display: flex; justify-content: center; gap: 0.75rem; flex-wrap: wrap; margin-top: auto; padding-top: 1rem; }

        /* Tooltip é€šç”¨æ ·å¼ */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: max-content; max-width: 250px; background-color: #374151; color: #fff; text-align: left; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 9999; opacity: 0; transition: opacity 0.3s ease 0.1s, visibility 0.3s ease 0.1s; font-size: 0.8rem; line-height: 1.4; white-space: normal; box-shadow: 0 2px 5px rgba(0,0,0,0.2); pointer-events: none; top: 100%; left: 0; transform: none; margin-top: 4px; }
        .tooltip .tooltiptext::after { content: none; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; transition-delay: 0.3s; }
        #status-section .tooltip .tooltiptext { top: auto; bottom: 115%; left: 50%; transform: translateX(-50%); margin-top: 0; }
        #status-section .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #374151 transparent transparent transparent; }

        /* æ–°å¢ï¼šç®¡ç†å‘˜é¡µé¢è¦†ç›–å±‚æ ·å¼ */
        .admin-page-overlay {
            position: fixed; /* å›ºå®šå®šä½ï¼Œè¦†ç›–æ•´ä¸ªè§†å£ */
            inset: 0; /* ç­‰åŒäº top:0; right:0; bottom:0; left:0; */
            background-color: #f3f4f6; /* èƒŒæ™¯è‰²ä¸ body ä¸€è‡´ */
            z-index: 90; /* å±‚çº§é«˜äºèœå•æ ï¼Œä½äºå¼¹çª— */
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; /* å‚ç›´å¸ƒå±€ */
            overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶å¯æ»šåŠ¨ */
        }
        .admin-page-overlay.active {
            display: flex; /* æ˜¾ç¤º */
        }
        .admin-page-header {
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 95; /* é«˜äºå†…å®¹ */
        }
        .admin-page-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: #111827;
        }
        .admin-page-content {
            padding: 1.5rem; /* p-6 */
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ */
        }
        .admin-back-button {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
        .admin-back-button:hover {
            background-color: #4b5563; /* gray-600 */
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1024px) {
            .main-container { flex-direction: column; }
            .module { min-height: auto; }
            .battle-modal-layout { flex-direction: column; max-height: 90vh; }
            .battle-left-column, .battle-right-column { width: 100%; }
            .battle-log { max-height: 250px; }
            .top-menu-bar { padding: 0.5rem 1rem; }
            .menu-title { font-size: 1.125rem; }
            .settings-button { font-size: 1.125rem; }
            .admin-page-header { padding: 0.5rem 1rem; } /* è°ƒæ•´ç®¡ç†é¡µé¢å¤´éƒ¨å†…è¾¹è· */
            .admin-page-title { font-size: 1rem; }
        }
        @media (max-width: 768px) {
            .synthesis-modal-layout { flex-direction: column; width: 90vw; }
            .modal-battle { width: 90vw; }
            .battle-skills { gap: 0.5rem; }
            .btn { padding: 0.5rem 0.75rem; font-size: 0.9rem; }
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
            .item-icon { width: 2.5rem; height: 2.5rem; font-size: 1rem; }
            .item-name { max-width: 3rem; }
            #inventory-list { grid-template-columns: repeat(auto-fill, minmax(3.5rem, 1fr)); }
            .collapsible-summary { max-width: 100px; }
            #synthesis-inventory-list.icon-view { grid-template-columns: repeat(auto-fill, minmax(4rem, 1fr)); gap: 0.5rem; }
             .top-menu-bar { padding: 0.5rem 0.75rem; }
             .menu-title { font-size: 1rem; }
             .settings-button { font-size: 1rem; padding: 0.4rem; }
             .admin-page-header { padding: 0.5rem 0.75rem; } /* è¿›ä¸€æ­¥è°ƒæ•´ç®¡ç†é¡µé¢å¤´éƒ¨å†…è¾¹è· */
        }
    </style>
</head>
<body class="flex flex-col">

    <header class="top-menu-bar">
        <div class="menu-left"> <div class="menu-title">æ–‡å­—å†’é™©æ¸¸æˆ</div>
            <div class="dropdown" id="world-dropdown">
                <button id="world-select-btn" class="dropdown-button" aria-label="é€‰æ‹©ä¸–ç•Œ">
                    <span id="current-world-name">è‰¾å°”æ–‡æ£®æ—</span> <i class="fas fa-chevron-down icon"></i> </button>
                <div id="world-dropdown-content" class="dropdown-content">
                    <a href="#" onclick="handleWorldSelect('è‰¾å°”æ–‡æ£®æ—')">è‰¾å°”æ–‡æ£®æ—</a>
                    <a href="#" onclick="handleWorldSelect('æ­»äº¡çŸ¿äº•')">æ­»äº¡çŸ¿äº•</a>
                    <a href="#" onclick="handleWorldSelect('è¥¿éƒ¨è’é‡')">è¥¿éƒ¨è’é‡ (ç¤ºä¾‹)</a>
                </div>
            </div>
        </div>
        <div class="settings-dropdown">
            <button id="settings-btn" class="settings-button" aria-label="è®¾ç½®">
                <i class="fas fa-cog"></i>
            </button>
            <div id="settings-dropdown-content" class="dropdown-content">
                <a href="#" onclick="handleMenuClick('user_info')">ç”¨æˆ·ä¿¡æ¯</a>
                <a href="#" onclick="handleMenuClick('import')">å¯¼å…¥</a>
                <a href="#" onclick="handleMenuClick('export')">å¯¼å‡º</a>
                <a href="#" onclick="handleMenuClick('ai_settings')">AIè®¾ç½®</a>
                <a href="#" onclick="handleMenuClick('admin_mode')">ç®¡ç†å‘˜æ¨¡å¼</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="module w-full lg:w-1/4">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="module-title !mb-0 !pb-0 !border-b-0">äººç‰©çŠ¶æ€</h2>
                 <div class="space-x-2">
                    <button id="details-btn" class="btn btn-info btn-sm">
                        <i class="fas fa-address-card mr-1"></i>è¯¦æƒ…
                    </button>
                    <button id="synthesis-btn" class="btn btn-warning btn-sm">
                        <i class="fas fa-magic mr-1"></i>åˆæˆ
                    </button>
                </div>
            </div>
            <div class="module-content space-y-3">
                <div class="space-y-1">
                    <div class="bar-label-group">
                        <label class="bar-label bar-label-hp">ç”Ÿå‘½å€¼</label>
                        <div class="progress-bar-container">
                            <div id="hp-bar" class="progress-bar progress-bar-hp" style="width: 85%;">85/100</div>
                        </div>
                    </div>
                    <div class="bar-label-group">
                        <label class="bar-label bar-label-mp">æ³•åŠ›å€¼</label>
                        <div class="progress-bar-container">
                            <div id="mp-bar" class="progress-bar progress-bar-mp" style="width: 60%;">60/100</div>
                        </div>
                    </div>
                </div>
                <div id="attributes-section">
                    <div class="collapsible-header" onclick="toggleCollapse('attributes')">
                        <h3 class="collapsible-title">æ ¸å¿ƒå±æ€§</h3>
                        <span class="collapsible-summary" id="attributes-summary">åŠ› 12 æ• 10 ä½“ 11 æ™º 15 æ„Ÿ 13 é­… 9</span>
                        <i class="fas fa-chevron-right collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content" id="attributes-content">
                        <div class="grid grid-cols-2 gap-2 pt-2">
                            <div class="stat-item"> <span class="stat-label">åŠ›é‡</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-str" class="stat-value">12</span> <button class="attr-adjust-btn">+</button> </div> </div>
                            <div class="stat-item"> <span class="stat-label">æ•æ·</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-dex" class="stat-value">10</span> <button class="attr-adjust-btn">+</button> </div> </div>
                            <div class="stat-item"> <span class="stat-label">ä½“è´¨</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-con" class="stat-value">11</span> <button class="attr-adjust-btn">+</button> </div> </div>
                            <div class="stat-item"> <span class="stat-label">æ™ºåŠ›</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-int" class="stat-value">15</span> <button class="attr-adjust-btn">+</button> </div> </div>
                            <div class="stat-item"> <span class="stat-label">æ„ŸçŸ¥</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-wis" class="stat-value">13</span> <button class="attr-adjust-btn">+</button> </div> </div>
                            <div class="stat-item"> <span class="stat-label">é­…åŠ›</span> <div> <button class="attr-adjust-btn">-</button> <span id="attr-cha" class="stat-value">9</span> <button class="attr-adjust-btn">+</button> </div> </div>
                        </div>
                    </div>
                </div>
                <div id="identity-section">
                     <div class="collapsible-header" onclick="toggleCollapse('identity')"> <h3 class="collapsible-title">èº«ä»½ä¿¡æ¯</h3> <span class="collapsible-summary" id="identity-summary">è‰¾ç‘å…‹</span> <i class="fas fa-chevron-right collapsible-icon"></i> </div>
                    <div class="collapsible-content" id="identity-content"> <div class="space-y-1 pt-2"> <div class="stat-item"><span class="stat-label">åç§°</span><span id="info-name" class="stat-value">è‰¾ç‘å…‹</span></div> <div class="stat-item"><span class="stat-label">é˜µè¥</span><span id="info-faction" class="stat-value">ä¸­ç«‹å–„è‰¯</span></div> <div class="stat-item"><span class="stat-label">èº«ä»½</span><span id="info-identity" class="stat-value">æµæµªè€…, è‰è¯å¸ˆå­¦å¾’</span></div> </div> </div>
                </div>
                <div id="status-section">
                     <div class="collapsible-header"> <h3 class="collapsible-title">çŠ¶æ€æ•ˆæœ</h3> <span class="collapsible-summary"></span> </div>
                    <div id="status-content" class="pt-1"> <div class="flex flex-wrap gap-x-4 gap-y-1"> <div class="status-item tooltip" data-status-id="status_energetic"> <span class="status-text status-positive-alt"><i class="fas fa-leaf mr-1"></i>ç²¾åŠ›å……æ²› (ä¸´æ—¶)</span> <span class="tooltiptext">æ•ˆæœï¼šè¡ŒåŠ¨æ•ˆç‡ç•¥å¾®æå‡ã€‚</span> </div> <div class="status-item tooltip" data-status-id="status_nimble"> <span class="status-text status-positive"><i class="fas fa-puzzle-piece mr-1"></i>å¿ƒçµæ‰‹å·§ (æ°¸ä¹…)</span> <span class="tooltiptext">æ•ˆæœï¼šè¿›è¡Œç²¾ç»†æ“ä½œæ—¶æœ‰ä¼˜åŠ¿ã€‚</span> </div> <div class="status-item tooltip" data-status-id="status_poisoned"> <span class="status-text status-negative"><i class="fas fa-skull-crossbones mr-1"></i>è½»å¾®ä¸­æ¯’ (ä¸´æ—¶)</span> <span class="tooltiptext">æ•ˆæœï¼šæ¯å›åˆæŸå¤±å°‘é‡ç”Ÿå‘½å€¼ã€‚</span> </div> </div> </div>
                </div>
                <div id="equipment-section">
                     <div class="collapsible-header" onclick="toggleCollapse('equipment')"> <h3 class="collapsible-title">è£…å¤‡</h3> <span class="collapsible-summary"></span> <i class="fas fa-chevron-right collapsible-icon"></i> </div>
                    <div class="collapsible-content expanded" id="equipment-content"> <div class="grid grid-cols-2 gap-2 pt-2"> <div class="equipment-item tooltip" data-equip-id="equip_sword_starter"> <div class="stat-item"> <span class="stat-label"><i class="fas fa-shield-alt w-4 text-center mr-1"></i>æ­¦å™¨</span> <span class="stat-value">æ–°æ‰‹çŸ­å‰‘</span> </div> <span class="tooltiptext">æ–°æ‰‹çŸ­å‰‘<br>æ”»å‡»åŠ› +3</span> </div> <div class="equipment-item tooltip" data-equip-id="equip_armor_leather"> <div class="stat-item"> <span class="stat-label"><i class="fas fa-tshirt w-4 text-center mr-1"></i>æŠ¤ç”²</span> <span class="stat-value">çš®ç”²</span> </div> <span class="tooltiptext">çš®ç”²<br>é˜²å¾¡åŠ› +5</span> </div> <div class="equipment-item tooltip" data-equip-id="equip_ring_lucky"> <div class="stat-item"> <span class="stat-label"><i class="fas fa-ring w-4 text-center mr-1"></i>é¥°å“</span> <span class="stat-value">å¹¸è¿æŒ‡ç¯</span> </div> <span class="tooltiptext">å¹¸è¿æŒ‡ç¯<br>å¹¸è¿ +1</span> </div> <div class="equipment-item tooltip" data-equip-id="empty_head"> <div class="stat-item text-gray-400"> <span class="stat-label"><i class="fas fa-hat-wizard w-4 text-center mr-1"></i>å¤´éƒ¨</span> <span class="stat-value">[ç©º]</span> </div> <span class="tooltiptext">å¤´éƒ¨<br>æ— è£…å¤‡</span> </div> <div class="equipment-item tooltip" data-equip-id="empty_feet"> <div class="stat-item text-gray-400"> <span class="stat-label"><i class="fas fa-shoe-prints w-4 text-center mr-1"></i>è„šéƒ¨</span> <span class="stat-value">[ç©º]</span> </div> <span class="tooltiptext">è„šéƒ¨<br>æ— è£…å¤‡</span> </div> </div> </div>
                </div>
                <div id="inventory-section">
                    <div class="flex justify-between items-center mb-1"> <h3 class="collapsible-title">ç‰©å“æ </h3> <span class="collapsible-summary" id="inventory-summary">0 / 0</span> </div>
                    <div id="inventory-content"> <div id="inventory-list" class="grid grid-cols-5 gap-2 pt-2"> </div> </div>
                </div>
            </div>
        </div>
        <div class="module w-full lg:w-1/2">
            <h2 class="module-title">äº‹ä»¶ä¿¡æ¯</h2>
            <div id="event-content" class="module-content space-y-4">
                <p class="text-gray-500 italic">åœ¨è¿™é‡Œæ˜¾ç¤ºå½“å‰å‘ç”Ÿçš„äº‹ä»¶...</p>
                <div id="event-description" class="prose prose-sm max-w-none text-gray-800"> <p>ä½ å°å¿ƒç¿¼ç¿¼åœ°è¸å…¥æ£®æ—ï¼Œè„šä¸‹çš„è½å¶å‘å‡ºæ²™æ²™çš„å£°å“ã€‚é˜³å…‰é€è¿‡å±‚å±‚å å çš„æ ‘å† ï¼Œåœ¨æ—é—´æŠ•ä¸‹æ–‘é©³çš„å…‰å½±ã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€æ½®æ¹¿æ³¥åœŸå’Œæ¤ç‰©çš„æ°”æ¯ã€‚</p> <p>ä½ æ³¨æ„åˆ°å‰æ–¹ä¸è¿œå¤„ä¼¼ä¹æœ‰ä¸€æ ªé—ªçƒç€å¾®å…‰çš„å¥‡ç‰¹è‰è¯ã€‚</p> </div>
                <div id="event-options" class="space-y-2"> <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('gather_herb')"> <i class="fas fa-hand-paper mr-2 w-4 text-center"></i> å°è¯•é‡‡é›†è‰è¯ </button> <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('investigate')"> <i class="fas fa-search mr-2 w-4 text-center"></i> ä»”ç»†è§‚å¯Ÿå‘¨å›´ç¯å¢ƒ </button> <button class="btn btn-danger w-full text-left justify-start" onclick="handleOptionClick('battle_slime')"> <i class="fas fa-sword mr-2 w-4 text-center"></i> [æˆ˜æ–—] æ”»å‡»æ—è¾¹çš„å²è±å§†! </button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('leave')"> <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> è°¨æ…èµ·è§ï¼Œåé€€ç¦»å¼€ </button> </div>
                <div id="event-result" class="mt-4 p-3 bg-blue-50 border-blue-200 text-blue-800 rounded-md text-sm" style="display: none;"> </div>
            </div>
        </div>
        <div class="module w-full lg:w-1/4">
            <h2 class="module-title">ä¸–ç•Œåœ°å›¾</h2>
            <div class="module-content">
                <div id="tile-info" class="mb-3 p-3 bg-gray-100 rounded border border-gray-200 text-sm"> <div><strong>å½“å‰ä½ç½®:</strong> <span id="current-coords">(5, 5)</span></div> <div><strong>åœ°å½¢:</strong> <span id="current-terrain">èŒ‚å¯†æ£®æ—</span></div> <div><strong>å¤©æ°”:</strong> <span id="current-weather">æ™´æœ—</span></div> </div>
                <div id="map-grid" class="grid grid-cols-10 gap-0.5 aspect-square"> </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModalOnClickOutside(event)">
        </div>

    <div id="admin-page-overlay" class="admin-page-overlay">
        <div class="admin-page-header">
            <h3 id="admin-page-title" class="admin-page-title">ç®¡ç†é¡µé¢</h3>
            <button id="admin-back-btn" class="btn admin-back-button btn-sm">
                <i class="fas fa-arrow-left mr-1"></i>è¿”å›æ¸¸æˆ
            </button>
        </div>
        <div id="admin-page-content" class="admin-page-content">
            <p class="text-gray-500 italic">æ­£åœ¨åŠ è½½ç®¡ç†é¡µé¢...</p>
        </div>
    </div>

    <script>
        // --- å…¨å±€å˜é‡ä¸çŠ¶æ€ ---
        const MAP_SIZE = 10;
        let currentPlayerPos = { x: 5, y: 5 };
        let currentModal = null;
        let collapseState = {
            attributes: true,
            identity: true,
            equipment: false,
        };
        let synthesisInventoryViewMode = 'icon';

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        let hpBar, mpBar, mapGrid, tileInfoCoords, tileInfoTerrain, tileInfoWeather,
            eventDescription, eventOptions, eventResult, modalOverlay, detailsBtn,
            synthesisBtn, inventoryList, inventorySummary,
            attributesSection, attributesContent, attributesSummary,
            identitySection, identityContent, identitySummary,
            statusSection, statusContent, equipmentSection, equipmentContent,
            inventorySection, inventoryContent,
            settingsBtn, settingsDropdownContent,
            adminPageOverlay, adminPageTitle, adminPageContent, adminBackBtn; // æ–°å¢ï¼šç®¡ç†å‘˜é¡µé¢ç›¸å…³

        // --- ä¼ªæ•°æ® (ä¿æŒä¸å˜) ---
        // ... (mockMapData, mockCharacterData, mockSynthesisRecipes ä¿æŒä¸å˜) ...
        const mockMapData = Array(MAP_SIZE).fill(0).map(() => Array(MAP_SIZE).fill({ terrain: 'æ£®æ—', weather: 'æ™´æœ—', icon: 'fas fa-tree', color: 'text-green-700', bgColor: 'bg-green-100' }));
        mockMapData[3][3] = { terrain: 'æ²³æµ', weather: 'æ™´æœ—', icon: 'fas fa-water', color: 'text-blue-700', bgColor: 'bg-blue-100' };
        mockMapData[7][6] = { terrain: 'å±±åœ°', weather: 'å¤šäº‘', icon: 'fas fa-mountain', color: 'text-gray-700', bgColor: 'bg-gray-200' };
        mockMapData[5][5].terrain = 'èŒ‚å¯†æ£®æ—';
        const mockCharacterData = { name: "è‰¾ç‘å…‹", level: 5, race: "äººç±»", class: "æ¸¸ä¾ ", hp: 85, maxHp: 100, mp: 60, maxMp: 100, str: 12, dex: 10, con: 11, int: 15, wis: 13, cha: 9, faction: "ä¸­ç«‹å–„è‰¯", identity: ["æµæµªè€…", "è‰è¯å¸ˆå­¦å¾’"], status: [ { id: 'status_energetic', name: "ç²¾åŠ›å……æ²›", type: "ä¸´æ—¶", desc: "è¡ŒåŠ¨æ•ˆç‡ç•¥å¾®æå‡ã€‚", icon: "fas fa-leaf", positive: true }, { id: 'status_nimble', name: "å¿ƒçµæ‰‹å·§", type: "æ°¸ä¹…", desc: "è¿›è¡Œç²¾ç»†æ“ä½œæ—¶æœ‰ä¼˜åŠ¿ã€‚", icon: "fas fa-puzzle-piece", positive: true }, { id: 'status_poisoned', name: "è½»å¾®ä¸­æ¯’", type: "ä¸´æ—¶", desc: "æ¯å›åˆæŸå¤±å°‘é‡ç”Ÿå‘½å€¼ã€‚", icon: "fas fa-skull-crossbones", positive: false } ], equipment: { weapon: { id: 'equip_sword_starter', name: "æ–°æ‰‹çŸ­å‰‘", desc: "æ”»å‡»åŠ› +3", icon: "fas fa-shield-alt" }, armor: { id: 'equip_armor_leather', name: "çš®ç”²", desc: "é˜²å¾¡åŠ› +5", icon: "fas fa-tshirt" }, accessory: { id: 'equip_ring_lucky', name: "å¹¸è¿æŒ‡ç¯", desc: "å¹¸è¿ +1", icon: "fas fa-ring" }, head: null, feet: null }, inventory: [ { id: 'item_apple', name: 'è‹¹æœ', desc: 'æ™®é€šçš„è‹¹æœï¼Œå¯ä»¥é£Ÿç”¨ã€‚', count: 3, icon: 'fas fa-apple-alt' }, { id: 'item_potion_heal_s', name: 'æ²»ç–—è¯æ°´(å°)', desc: 'æ¢å¤å°‘é‡ç”Ÿå‘½å€¼ã€‚', count: 1, icon: 'fas fa-flask' }, { id: 'item_scroll_mystic', name: 'ç¥ç§˜å·è½´', desc: 'ä¼¼ä¹è®°è½½ç€ä»€ä¹ˆã€‚', count: 1, icon: 'fas fa-scroll' }, { id: 'item_key_rusty', name: 'ç”Ÿé”ˆçš„é’¥åŒ™', desc: 'ä¹Ÿè®¸èƒ½æ‰“å¼€ä»€ä¹ˆé”ã€‚', count: 1, icon: 'fas fa-key' }, { id: 'item_bone_strange', name: 'å¥‡æ€ªçš„éª¨å¤´', desc: 'ä¸çŸ¥æ˜¯ä»€ä¹ˆç”Ÿç‰©çš„ã€‚', count: 2, icon: 'fas fa-bone' } ], inventoryCapacity: 20 };
        const mockSynthesisRecipes = [ { inputs: ['è‹¹æœ', 'è‹¹æœ'], output: { name: 'è‹¹æœé…±', desc: 'ç”œç”œçš„è‹¹æœé…±ã€‚', icon: 'fas fa-jar' }, probability: 80 }, { inputs: ['å¥‡æ€ªçš„éª¨å¤´', 'å¥‡æ€ªçš„éª¨å¤´'], output: { name: 'éª¨ç²‰', desc: 'ç£¨ç¢çš„éª¨å¤´ç²‰æœ«ã€‚', icon: 'fas fa-mortar-pestle' }, probability: 100 }, { inputs: ['æ²»ç–—è¯æ°´(å°)', 'è‰è¯'], output: { name: 'æ²»ç–—è¯æ°´(ä¸­)', desc: 'æ¢å¤ä¸­é‡ç”Ÿå‘½å€¼ã€‚', icon: 'fas fa-prescription-bottle-alt' }, probability: 70 }, { inputs: ['ç”Ÿé”ˆçš„é’¥åŒ™', 'çŸ¿çŸ³'], output: { name: 'æ™®é€šçš„é’¥åŒ™', desc: 'ä¸€æŠŠæ™®é€šçš„é“œé’¥åŒ™ã€‚', icon: 'fas fa-key' }, probability: 50 }, { inputs: ['å¥‡æ€ªçš„éª¨å¤´', 'è‰è¯'], output: { name: 'å¥‡æ€ªçš„è¯è†', desc: 'ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨ã€‚', icon: 'fas fa-bong' }, probability: 90 }, ];


        // --- åœ°å›¾åŠŸèƒ½ (ä¿æŒä¸å˜) ---
        // ... (renderMap, handleMapTileClick, updateTileInfo ä¿æŒä¸å˜) ...
        function renderMap() { if (!mapGrid) return; mapGrid.innerHTML = ''; for (let y = 0; y < MAP_SIZE; y++) { for (let x = 0; x < MAP_SIZE; x++) { const tileData = mockMapData[y][x]; const tile = document.createElement('div'); tile.classList.add('map-tile', tileData.bgColor, tileData.color); tile.dataset.x = x; tile.dataset.y = y; tile.innerHTML = `<i class="${tileData.icon} tooltip"><span class="tooltiptext">${tileData.terrain} (${x}, ${y})</span></i>`; if (x === currentPlayerPos.x && y === currentPlayerPos.y) { tile.classList.add('player-location'); } tile.addEventListener('click', handleMapTileClick); mapGrid.appendChild(tile); } } updateTileInfo(currentPlayerPos.x, currentPlayerPos.y); }
        function handleMapTileClick(event) { const tile = event.currentTarget; const x = parseInt(tile.dataset.x); const y = parseInt(tile.dataset.y); currentPlayerPos = { x, y }; renderMap(); triggerEvent(x, y); }
        function updateTileInfo(x, y) { if (!tileInfoCoords || !tileInfoTerrain || !tileInfoWeather) return; const tileData = mockMapData[y][x]; tileInfoCoords.textContent = `(${x}, ${y})`; tileInfoTerrain.textContent = tileData.terrain; tileInfoWeather.textContent = tileData.weather; }


        // --- äº‹ä»¶åŠŸèƒ½ (ä¿æŒä¸å˜) ---
        // ... (triggerEvent, handleOptionClick ä¿æŒä¸å˜) ...
        function triggerEvent(x, y) { if (!eventDescription || !eventOptions || !eventResult) return; const tileData = mockMapData[y][x]; console.log(`è§¦å‘äº‹ä»¶äº (${x}, ${y}), åœ°å½¢: ${tileData.terrain}`); eventResult.style.display = 'none'; eventResult.textContent = ''; let desc = ''; let optionsHtml = ''; switch (tileData.terrain) { case 'æ£®æ—': case 'èŒ‚å¯†æ£®æ—': desc = `<p>ä½ æ·±å…¥äº†è¿™ç‰‡${tileData.terrain}ã€‚å››å‘¨æ ‘æœ¨é«˜è€¸ï¼Œå…‰çº¿æ˜æš—ã€‚</p>`; if (Math.random() < 0.4) { desc += `<p>ä½ å‘ç°åœ°ä¸Šæ•£è½ç€ä¸€äº› ${Math.random() < 0.5 ? 'å¹²æ¯çš„æ ‘æ' : 'ä¸çŸ¥åçš„æµ†æœ'}ã€‚</p>`; optionsHtml = ` <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('gather_wood')"><i class="fas fa-hand-paper mr-2 w-4 text-center"></i> æ”¶é›†æ ‘æ</button> <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('gather_berry')"><i class="fas fa-hand-paper mr-2 w-4 text-center"></i> é‡‡é›†æµ†æœ</button> <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('investigate_forest')"><i class="fas fa-search mr-2 w-4 text-center"></i> æœç´¢å‘¨å›´</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('wait')"><i class="fas fa-clock mr-2 w-4 text-center"></i> åŸåœ°ç­‰å¾…</button> `; } else if (Math.random() < 0.7) { desc += `<p>ä¸€åª ${Math.random() < 0.5 ? 'é‡å…”' : 'æ¾é¼ '} å¿«é€Ÿè·‘è¿‡ï¼Œæ¶ˆå¤±åœ¨çŒæœ¨ä¸›ä¸­ã€‚</p>`; optionsHtml = ` <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('investigate_forest')"><i class="fas fa-search mr-2 w-4 text-center"></i> æœç´¢å‘¨å›´</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('wait')"><i class="fas fa-clock mr-2 w-4 text-center"></i> åŸåœ°ç­‰å¾…</button> `; } else { desc += `<p>ä½ å¬åˆ°è¿œå¤„ä¼ æ¥å¥‡æ€ªçš„å£°å“ï¼Œä¼¼ä¹æœ‰ä»€ä¹ˆä¸œè¥¿åœ¨é è¿‘ï¼</p>`; optionsHtml = ` <button class="btn btn-warning w-full text-left justify-start" onclick="handleOptionClick('prepare_defense')"><i class="fas fa-shield-alt mr-2 w-4 text-center"></i> å‡†å¤‡é˜²å¾¡</button> <button class="btn btn-danger w-full text-left justify-start" onclick="handleOptionClick('battle_goblin')"><i class="fas fa-sword mr-2 w-4 text-center"></i> [æˆ˜æ–—] ä¸»åŠ¨å‡ºå‡»ï¼</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('hide')"><i class="fas fa-eye-slash mr-2 w-4 text-center"></i> å°è¯•èº²è—</button> `; } break; case 'æ²³æµ': desc = `<p>ä½ æ¥åˆ°ä¸€æ¡${tileData.weather === 'å¤šäº‘' ? 'æµ‘æµŠçš„' : 'æ¸…æ¾ˆçš„'}æ²³æµè¾¹ã€‚æ²³æ°´æ½ºæ½ºæµæ·Œã€‚</p>`; optionsHtml = ` <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('drink_water')"><i class="fas fa-tint mr-2 w-4 text-center"></i> å–æ°´</button> <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('search_riverbank')"><i class="fas fa-search mr-2 w-4 text-center"></i> æœç´¢æ²³å²¸</button> <button class="btn btn-info w-full text-left justify-start" onclick="handleOptionClick('try_fishing')"><i class="fas fa-fish mr-2 w-4 text-center"></i> å°è¯•é’“é±¼</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('wait')"><i class="fas fa-clock mr-2 w-4 text-center"></i> åœ¨æ²³è¾¹ä¼‘æ¯</button> `; break; case 'å±±åœ°': desc = `<p>ä½ çˆ¬ä¸Šäº†ä¸€ç‰‡å´å²–çš„å±±åœ°ã€‚å±±é£${tileData.weather === 'å¤šäº‘' ? 'å‘¼å•¸' : 'å¾®æ‹‚'}ï¼Œè§†é‡å¼€é˜”ã€‚</p>`; if (Math.random() < 0.5) { desc += `<p>ä½ åœ¨å²©çŸ³ç¼éš™ä¸­å‘ç°äº†ä¸€äº› ${Math.random() < 0.6 ? 'é—ªäº®çš„çŸ¿çŸ³' : 'å¥‡ç‰¹çš„è‹”è—“'}ã€‚</p>`; optionsHtml = ` <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('gather_ore')"><i class="fas fa-gem mr-2 w-4 text-center"></i> å¼€é‡‡çŸ¿çŸ³</button> <button class="btn btn-success w-full text-left justify-start" onclick="handleOptionClick('gather_moss')"><i class="fas fa-seedling mr-2 w-4 text-center"></i> é‡‡é›†è‹”è—“</button> <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('scout_mountain')"><i class="fas fa-binoculars mr-2 w-4 text-center"></i> ä¾¦å¯Ÿè¿œå¤„</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('wait')"><i class="fas fa-clock mr-2 w-4 text-center"></i> ä¼‘æ¯ç‰‡åˆ»</button> `; } else { desc += `<p>ä½ å‘ç°äº†ä¸€ä¸ªéšè”½çš„å±±æ´å…¥å£ã€‚</p>`; optionsHtml = ` <button class="btn btn-warning w-full text-left justify-start" onclick="handleOptionClick('enter_cave')"><i class="fas fa-dungeon mr-2 w-4 text-center"></i> è¿›å…¥å±±æ´</button> <button class="btn btn-primary w-full text-left justify-start" onclick="handleOptionClick('scout_mountain')"><i class="fas fa-binoculars mr-2 w-4 text-center"></i> ä¾¦å¯Ÿè¿œå¤„</button> <button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('ignore_cave')"><i class="fas fa-times mr-2 w-4 text-center"></i> å¿½ç•¥å±±æ´</button> `; } break; default: desc = `<p>ä½ æ¥åˆ°äº† (${x}, ${y})ã€‚</p>`; optionsHtml = `<button class="btn btn-secondary w-full text-left justify-start" onclick="handleOptionClick('wait')"><i class="fas fa-clock mr-2 w-4 text-center"></i> åŸåœ°ç­‰å¾…</button>`; } eventDescription.innerHTML = desc; eventOptions.innerHTML = optionsHtml; }
        function handleOptionClick(optionId) { if (!eventResult) return; console.log(`é€‰æ‹©äº†é€‰é¡¹: ${optionId}`); let resultText = ''; let resultClass = 'bg-blue-50 border-blue-200 text-blue-800'; if (optionId.startsWith('battle_')) { const enemyType = optionId.split('_')[1]; openModal('battle', { enemyType: enemyType }); return; } switch (optionId) { case 'gather_herb': resultText = 'ä½ æˆåŠŸé‡‡é›†åˆ°äº†ä¸€äº›[æ™®é€šè‰è¯] x1ã€‚'; const herb = mockCharacterData.inventory.find(i => i.id === 'item_herb_common'); if (herb) { herb.count += 1; } else { mockCharacterData.inventory.push({ id: 'item_herb_common', name: 'è‰è¯', desc: 'å¸¸è§çš„è‰è¯ã€‚', count: 1, icon: 'fas fa-leaf' }); } updateInventoryUI(); resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'gather_wood': resultText = 'ä½ æ”¶é›†äº†ä¸€äº›[å¹²æ¯çš„æ ‘æ] x2ã€‚'; const wood = mockCharacterData.inventory.find(i => i.id === 'item_wood_branch'); if (wood) { wood.count += 2; } else { mockCharacterData.inventory.push({ id: 'item_wood_branch', name: 'æ ‘æ', desc: 'å¹²æ¯çš„æ ‘æã€‚', count: 2, icon: 'fas fa-tree' }); } updateInventoryUI(); resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'gather_berry': const isGoodBerry = Math.random() < 0.7; resultText = isGoodBerry ? 'ä½ é‡‡é›†äº†ä¸€äº›[çº¢è‰²æµ†æœ] x3ã€‚çœ‹èµ·æ¥å¯ä»¥åƒã€‚' : 'ä½ é‡‡é›†äº†ä¸€äº›[ç´«è‰²æµ†æœ] x2ã€‚æœ€å¥½ä¸è¦ä¹±åƒã€‚'; const berryId = isGoodBerry ? 'item_berry_red' : 'item_berry_purple'; const berryName = isGoodBerry ? 'çº¢è‰²æµ†æœ' : 'ç´«è‰²æµ†æœ'; const berryDesc = isGoodBerry ? 'å¯ä»¥åƒçš„æµ†æœã€‚' : 'æœ€å¥½ä¸è¦ä¹±åƒã€‚'; const berryCount = isGoodBerry ? 3 : 2; const berry = mockCharacterData.inventory.find(i => i.id === berryId); if (berry) { berry.count += berryCount; } else { mockCharacterData.inventory.push({ id: berryId, name: berryName, desc: berryDesc, count: berryCount, icon: 'fas fa-apple-alt' }); } updateInventoryUI(); resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'gather_ore': resultText = 'ä½ åŠªåŠ›æ•²ä¸‹äº†ä¸€äº›[é“œçŸ¿çŸ³] x1ã€‚'; const ore = mockCharacterData.inventory.find(i => i.id === 'item_ore_copper'); if (ore) { ore.count += 1; } else { mockCharacterData.inventory.push({ id: 'item_ore_copper', name: 'é“œçŸ¿çŸ³', desc: 'åŸºç¡€çš„çŸ¿çŸ³ã€‚', count: 1, icon: 'fas fa-gem' }); } updateInventoryUI(); resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'gather_moss': resultText = 'ä½ æ”¶é›†äº†ä¸€äº›[å‘å…‰çš„è‹”è—“] x1ã€‚'; const moss = mockCharacterData.inventory.find(i => i.id === 'item_moss_glowing'); if (moss) { moss.count += 1; } else { mockCharacterData.inventory.push({ id: 'item_moss_glowing', name: 'å‘å…‰è‹”è—“', desc: 'å‘å‡ºå¾®å¼±çš„å…‰èŠ’ã€‚', count: 1, icon: 'fas fa-seedling' }); } updateInventoryUI(); resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'investigate': case 'investigate_forest': case 'search_riverbank': case 'scout_mountain': resultText = 'ä½ ä»”ç»†è§‚å¯Ÿäº†å››å‘¨ï¼Œæš‚æ—¶æ²¡æœ‰å‘ç°ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ã€‚'; resultClass = 'bg-yellow-50 border-yellow-200 text-yellow-800'; break; case 'prepare_defense': resultText = 'ä½ æé«˜äº†è­¦æƒ•ï¼Œåšå¥½äº†é˜²å¾¡å‡†å¤‡ã€‚'; resultClass = 'bg-yellow-50 border-yellow-200 text-yellow-800'; break; case 'hide': const hideSuccess = Math.random() < 0.6; resultText = hideSuccess ? 'ä½ æˆåŠŸåœ°èº²è—äº†èµ·æ¥ï¼Œæ²¡æœ‰è¢«å‘ç°ã€‚' : 'ä½ çš„èº²è—ä¸å¤ªæˆåŠŸï¼Œä¼¼ä¹è¢«ä»€ä¹ˆä¸œè¥¿æ³¨æ„åˆ°äº†ï¼'; resultClass = hideSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'; break; case 'drink_water': resultText = 'æ¸…å‡‰çš„æ²³æ°´è®©ä½ ç²¾ç¥ä¸€æŒ¯ã€‚'; resultClass = 'bg-green-50 border-green-200 text-green-800'; break; case 'try_fishing': const fishSuccess = Math.random() < 0.3; resultText = fishSuccess ? 'ä½ é’“åˆ°äº†ä¸€æ¡[å°é±¼] x1ï¼' : 'ç­‰äº†åŠå¤©ï¼Œä»€ä¹ˆä¹Ÿæ²¡é’“åˆ°ã€‚'; if (fishSuccess) { const fish = mockCharacterData.inventory.find(i => i.id === 'item_fish_small'); if (fish) { fish.count += 1; } else { mockCharacterData.inventory.push({ id: 'item_fish_small', name: 'å°é±¼', desc: 'å¯ä»¥çƒ¤ç€åƒã€‚', count: 1, icon: 'fas fa-fish' }); } updateInventoryUI(); } resultClass = fishSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-yellow-50 border-yellow-200 text-yellow-800'; break; case 'enter_cave': resultText = 'ä½ èµ°è¿›äº†é»‘æš—çš„å±±æ´...ï¼ˆåç»­äº‹ä»¶å¾…å¼€å‘ï¼‰'; resultClass = 'bg-purple-50 border-purple-200 text-purple-800'; break; case 'ignore_cave': resultText = 'ä½ å†³å®šä¸è¿›å…¥å±±æ´ï¼Œç»§ç»­åœ¨å±±åœ°æ¢ç´¢ã€‚'; break; case 'leave': case 'wait': default: resultText = 'ä½ å†³å®šæš‚æ—¶ä¸åšä»»ä½•è¡ŒåŠ¨ã€‚'; break; } eventResult.textContent = resultText; eventResult.className = `mt-4 p-3 rounded-md text-sm ${resultClass}`; eventResult.style.display = 'block'; }


        // --- å¼¹çª—åŠŸèƒ½ (éƒ¨åˆ†ä¿®æ”¹) ---
        /**
         * @description æ‰“å¼€æŒ‡å®šç±»å‹çš„å¼¹çª—
         * @function openModal
         * @param {'details' | 'enemy_details' | 'synthesis' | 'battle' | 'admin'} type - å¼¹çª—ç±»å‹ (æ–°å¢ 'admin')
         * @param {object} [data={}] - ä¼ é€’ç»™å¼¹çª—çš„æ•°æ®
         * @returns {void} - æ— è¿”å›å€¼
         */
        function openModal(type, data = {}) {
            currentModal = type;
            let modalContentHtml = '';
            let modalSizeClass = '';

            switch (type) {
                case 'details':
                    modalContentHtml = generateDetailsModal(mockCharacterData, "äººç‰©è¯¦æƒ…");
                    modalSizeClass = 'modal-details';
                    break;
                case 'enemy_details':
                    modalContentHtml = generateDetailsModal(data.enemyData, `æ•Œäººè¯¦æƒ… - ${data.enemyData.name}`);
                    modalSizeClass = 'modal-details';
                    break;
                case 'synthesis':
                    modalContentHtml = generateSynthesisModal();
                    modalSizeClass = 'modal-synthesis';
                    break;
                case 'battle':
                    modalContentHtml = generateBattleModal(data.enemyType || 'æœªçŸ¥æ•Œäºº');
                    modalSizeClass = 'modal-battle';
                    break;
                // æ–°å¢ï¼šç®¡ç†å‘˜æ¨¡å¼å¼¹çª—
                case 'admin':
                    modalContentHtml = generateAdminModal();
                    modalSizeClass = 'modal-admin';
                    break;
                default: console.error('æœªçŸ¥çš„å¼¹çª—ç±»å‹:', type); return;
            }

            modalOverlay.innerHTML = `<div class="modal-container ${modalSizeClass}">${modalContentHtml}</div>`;
            modalOverlay.classList.add('active');

            if (type === 'synthesis') { initializeSynthesisModal(); }
            if (type === 'battle') { initializeBattleModal(); }
            // æ–°å¢ï¼šç®¡ç†å‘˜å¼¹çª—çš„åˆå§‹åŒ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (type === 'admin') { initializeAdminModal(); }
        }
        /**
         * @description å…³é—­å½“å‰æ‰“å¼€çš„å¼¹çª—
         * @function closeModal
         * @returns {void} - æ— è¿”å›å€¼
         */
        function closeModal() {
            modalOverlay.classList.remove('active');
            currentModal = null;
            setTimeout(() => { modalOverlay.innerHTML = ''; }, 300);
        }
        /**
         * @description å¤„ç†ç‚¹å‡»å¼¹çª—å¤–éƒ¨åŒºåŸŸå…³é—­å¼¹çª—çš„é€»è¾‘ (æˆ˜æ–—å’Œç®¡ç†å‘˜é¡µé¢é™¤å¤–)
         * @function closeModalOnClickOutside
         * @param {MouseEvent} event - ç‚¹å‡»äº‹ä»¶å¯¹è±¡
         * @returns {void} - æ— è¿”å›å€¼
         */
        function closeModalOnClickOutside(event) {
            // ä¿®æ”¹ï¼šç®¡ç†å‘˜å¼¹çª—å’Œæˆ˜æ–—å¼¹çª—ç‚¹å‡»å¤–éƒ¨ä¸å…³é—­
            if (event.target === modalOverlay && currentModal !== 'battle' && currentModal !== 'admin') {
                closeModal();
            }
        }
        /**
         * @description ç”Ÿæˆå®ä½“è¯¦æƒ…å¼¹çª— HTML (ä¿æŒä¸å˜)
         * @function generateDetailsModal
         * @param {object} entityData - å®ä½“æ•°æ®
         * @param {string} title - å¼¹çª—æ ‡é¢˜
         * @returns {string} - HTML å­—ç¬¦ä¸²
         */
        function generateDetailsModal(entityData, title) { if (!entityData) return '<p>é”™è¯¯ï¼šæ— æ³•åŠ è½½è¯¦æƒ…æ•°æ®ã€‚</p>'; const statusHtml = (entityData.status || []).map(s => `<li class="text-sm ${s.positive === false ? 'text-red-600' : 'text-green-600'}"><i class="${s.icon} mr-1"></i>${s.name} (${s.type}): ${s.desc}</li>`).join(''); const equipmentHtml = Object.entries(entityData.equipment || {}).map(([slot, item]) => `<li class="text-sm">${slot}: ${item ? `${item.name} (${item.desc})` : '[ç©º]'}</li>`).join(''); return ` <button class="modal-close-btn" onclick="closeModal()">&times;</button> <h3 class="modal-title">${title}</h3> <div class="space-y-3 text-sm text-gray-800"> ${entityData.level ? `<p><strong>ç­‰çº§:</strong> ${entityData.level}</p>` : ''} ${entityData.race ? `<p><strong>ç§æ—:</strong> ${entityData.race}</p>` : ''} ${entityData.class ? `<p><strong>èŒä¸š:</strong> ${entityData.class}</p>` : ''} <div class="pt-2 border-t"> <h4 class="font-semibold mb-1">å±æ€§:</h4> <p>åŠ›é‡: ${entityData.str || 'N/A'}, æ•æ·: ${entityData.dex || 'N/A'}, ä½“è´¨: ${entityData.con || 'N/A'}</p> <p>æ™ºåŠ›: ${entityData.int || 'N/A'}, æ„ŸçŸ¥: ${entityData.wis || 'N/A'}, é­…åŠ›: ${entityData.cha || 'N/A'}</p> </div> ${statusHtml ? `<div class="pt-2 border-t"><h4 class="font-semibold mb-1">çŠ¶æ€:</h4><ul>${statusHtml}</ul></div>` : ''} ${equipmentHtml ? `<div class="pt-2 border-t"><h4 class="font-semibold mb-1">è£…å¤‡:</h4><ul>${equipmentHtml}</ul></div>` : ''} ${entityData.backgroundStory ? `<div class="pt-2 border-t"><h4 class="font-semibold mb-1">èƒŒæ™¯æ•…äº‹:</h4><p class="italic text-gray-600">${entityData.backgroundStory}</p></div>` : ''} ${entityData.description ? `<div class="pt-2 border-t"><h4 class="font-semibold mb-1">æè¿°:</h4><p class="italic text-gray-600">${entityData.description}</p></div>` : ''} </div> <div class="mt-6 text-right"> <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button> </div>`; }
        /**
         * @description ç”Ÿæˆåˆæˆå¼¹çª— HTML (ä¿æŒä¸å˜)
         * @function generateSynthesisModal
         * @returns {string} - HTML å­—ç¬¦ä¸²
         */
        function generateSynthesisModal() { const inventoryHtml = mockCharacterData.inventory.map(item => ` <div class="item-display tooltip" draggable="true" data-item-id="${item.id}" data-item-name="${item.name}"> <div class="item-icon synthesis-item-icon"> <i class="${item.icon}"></i> ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''} </div> <span class="item-name">${item.name}</span> <span class="tooltiptext">${item.name}<br>${item.desc}</span> </div> `).join(''); return ` <button class="modal-close-btn" onclick="closeModal()">&times;</button> <div class="synthesis-modal-layout"> <div class="synthesis-column"> <div class="flex justify-between items-center mb-3"> <h4 class="text-lg font-semibold text-gray-700">åº“å­˜ç‰©å“</h4> <button id="toggle-synthesis-view-btn" class="btn btn-outline-gray btn-sm"> <i class="fas fa-list mr-1"></i>åˆ—è¡¨è§†å›¾ </button> </div> <div id="synthesis-inventory-list-container"> <div id="synthesis-inventory-list" class="icon-view"> ${inventoryHtml} </div> </div> </div> <div class="synthesis-column flex-shrink-0 w-full md:w-1/3"> <h4 class="text-lg font-semibold mb-3 text-gray-700">åˆæˆåŒºåŸŸ</h4> <p class="text-xs text-gray-500 mb-2">ä»å·¦ä¾§æ‹–æ‹½ç‰©å“åˆ°è¿™é‡Œï¼Œç‚¹å‡»ç§»é™¤ã€‚</p> <div id="synthesis-drop-area" class="synthesis-area flex-grow"></div> <div id="synthesis-result-text" class="text-center text-sm font-medium text-gray-700 h-6 my-2"></div> <button id="synthesis-execute-btn" class="btn btn-warning w-full mt-auto"> <i class="fas fa-magic mr-2"></i>æ‰§è¡Œåˆæˆ </button> </div> <div class="synthesis-column"> <h4 class="text-lg font-semibold mb-3 text-gray-700">ç›¸å…³é…æ–¹</h4> <div id="synthesis-formula-list" class="formula-list space-y-1"> <p class="text-gray-500 text-sm italic">æ”¾å…¥ç‰©å“ä»¥æŸ¥çœ‹ç›¸å…³é…æ–¹...</p> </div> </div> </div> `; }
        /**
         * @description åˆå§‹åŒ–åˆæˆå¼¹çª—é€»è¾‘ (ä¿æŒä¸å˜)
         * @function initializeSynthesisModal
         * @returns {void} - æ— è¿”å›å€¼
         */
        function initializeSynthesisModal() { const inventoryListContainer = document.getElementById('synthesis-inventory-list'); const toggleViewBtn = document.getElementById('toggle-synthesis-view-btn'); const dropArea = document.getElementById('synthesis-drop-area'); const formulaList = document.getElementById('synthesis-formula-list'); const resultText = document.getElementById('synthesis-result-text'); const executeBtn = document.getElementById('synthesis-execute-btn'); renderSynthesisInventory(synthesisInventoryViewMode); toggleViewBtn.addEventListener('click', () => { synthesisInventoryViewMode = synthesisInventoryViewMode === 'icon' ? 'list' : 'icon'; renderSynthesisInventory(synthesisInventoryViewMode); toggleViewBtn.innerHTML = synthesisInventoryViewMode === 'icon' ? '<i class="fas fa-list mr-1"></i>åˆ—è¡¨è§†å›¾' : '<i class="fas fa-th-large mr-1"></i>å›¾æ ‡è§†å›¾'; }); dropArea.addEventListener('dragover', (event) => { event.preventDefault(); event.dataTransfer.dropEffect = 'copy'; dropArea.classList.add('bg-blue-50', 'border-blue-300'); }); dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('bg-blue-50', 'border-blue-300'); }); dropArea.addEventListener('drop', (event) => { event.preventDefault(); dropArea.classList.remove('bg-blue-50', 'border-blue-300'); try { const itemData = JSON.parse(event.dataTransfer.getData('text/plain')); const inventoryItem = mockCharacterData.inventory.find(invItem => invItem.id === itemData.id); const countInArea = Array.from(dropArea.querySelectorAll('.item-display')).filter(el => el.dataset.itemId === itemData.id).length; if (inventoryItem && inventoryItem.count > countInArea) { const newItemElement = document.createElement('div'); newItemElement.classList.add('item-display', 'tooltip'); newItemElement.dataset.itemId = itemData.id; newItemElement.dataset.itemName = itemData.name; newItemElement.innerHTML = ` <div class="item-icon synthesis-item-icon"><i class="${itemData.icon}"></i></div> <span class="item-name">${itemData.name}</span> <span class="tooltiptext">${itemData.name}</span>`; newItemElement.addEventListener('click', () => { newItemElement.remove(); updateSynthesisFormulas(); }); dropArea.appendChild(newItemElement); updateSynthesisFormulas(); } else { showSynthesisResult('åº“å­˜ä¸è¶³!', 'text-red-500'); } } catch (e) { console.error("æ‹–æ”¾æ•°æ®è§£æå¤±è´¥:", e); } }); executeBtn.addEventListener('click', () => { const itemsInArea = Array.from(dropArea.querySelectorAll('.item-display')); if (itemsInArea.length < 1) { showSynthesisResult('è¯·æ”¾å…¥ç‰©å“!', 'text-yellow-600'); return; } const itemNamesInArea = itemsInArea.map(item => item.dataset.itemName).sort(); const matchedRecipe = mockSynthesisRecipes.find(recipe => { const sortedInputs = [...recipe.inputs].sort(); return JSON.stringify(sortedInputs) === JSON.stringify(itemNamesInArea); }); if (matchedRecipe) { let canCraft = true; const requiredCounts = {}; matchedRecipe.inputs.forEach(name => { requiredCounts[name] = (requiredCounts[name] || 0) + 1; }); for(const name in requiredCounts) { const invItem = mockCharacterData.inventory.find(i => i.name === name); if (!invItem || invItem.count < requiredCounts[name]) { canCraft = false; showSynthesisResult(`åº“å­˜ä¸è¶³: ${name}`, 'text-red-500'); break; } } if (canCraft) { if (Math.random() * 100 < matchedRecipe.probability) { showSynthesisResult(`åˆæˆæˆåŠŸ! è·å¾—: ${matchedRecipe.output.name}`, 'text-green-600'); matchedRecipe.inputs.forEach(name => { const invItem = mockCharacterData.inventory.find(i => i.name === name); if (invItem) invItem.count -= 1; }); mockCharacterData.inventory = mockCharacterData.inventory.filter(i => i.count > 0); const outputItem = mockCharacterData.inventory.find(i => i.name === matchedRecipe.output.name); if (outputItem) { outputItem.count += 1; } else { mockCharacterData.inventory.push({ id: `item_${matchedRecipe.output.name.toLowerCase().replace(/\s+/g, '_')}`, name: matchedRecipe.output.name, desc: matchedRecipe.output.desc, count: 1, icon: matchedRecipe.output.icon }); } updateInventoryUI(); renderSynthesisInventory(synthesisInventoryViewMode); dropArea.innerHTML = ''; updateSynthesisFormulas(); } else { showSynthesisResult(`åˆæˆå¤±è´¥! (æ¦‚ç‡: ${matchedRecipe.probability}%)`, 'text-red-500'); } } } else { showSynthesisResult('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é…æ–¹...', 'text-gray-500'); } }); updateSynthesisFormulas(); }
        /**
         * @description æ¸²æŸ“åˆæˆå¼¹çª—åº“å­˜åˆ—è¡¨ (ä¿æŒä¸å˜)
         * @function renderSynthesisInventory
         * @param {'icon' | 'list'} mode - è§†å›¾æ¨¡å¼
         * @returns {void} - æ— è¿”å›å€¼
         */
        function renderSynthesisInventory(mode) { const inventoryListEl = document.getElementById('synthesis-inventory-list'); if (!inventoryListEl) return; inventoryListEl.innerHTML = ''; inventoryListEl.className = mode === 'icon' ? 'icon-view' : 'list-view'; mockCharacterData.inventory.forEach(item => { const itemWrapper = document.createElement('div'); itemWrapper.classList.add('item-display', 'tooltip'); itemWrapper.draggable = true; itemWrapper.dataset.itemId = item.id; itemWrapper.dataset.itemName = item.name; const itemIconHtml = ` <div class="item-icon ${mode === 'icon' ? 'synthesis-item-icon' : ''}"> <i class="${item.icon || 'fas fa-box'}"></i> ${item.count > 1 && mode === 'icon' ? `<span class="item-count">${item.count}</span>` : ''} </div> `; const itemNameHtml = `<span class="item-name">${item.name}</span>`; const itemCountListHtml = mode === 'list' ? `<span class="item-count">(x${item.count})</span>` : ''; const tooltipHtml = `<span class="tooltiptext">${item.name}<br>${item.desc}</span>`; if (mode === 'icon') { itemWrapper.innerHTML = itemIconHtml + itemNameHtml + tooltipHtml; } else { itemWrapper.innerHTML = itemIconHtml + itemNameHtml + itemCountListHtml + tooltipHtml; } itemWrapper.addEventListener('dragstart', (event) => { const iconElement = itemWrapper.querySelector('.item-icon i'); if (!iconElement) return; event.dataTransfer.setData('text/plain', JSON.stringify({ id: item.id, name: item.name, icon: iconElement.className })); event.dataTransfer.effectAllowed = 'copy'; itemWrapper.classList.add('opacity-50'); }); itemWrapper.addEventListener('dragend', (event) => { itemWrapper.classList.remove('opacity-50'); }); inventoryListEl.appendChild(itemWrapper); }); }
        /**
         * @description æ›´æ–°åˆæˆå¼¹çª—ç›¸å…³é…æ–¹ (ä¿æŒä¸å˜)
         * @function updateSynthesisFormulas
         * @returns {void} - æ— è¿”å›å€¼
         */
        function updateSynthesisFormulas() { const formulaList = document.getElementById('synthesis-formula-list'); const itemsInArea = Array.from(document.querySelectorAll('#synthesis-drop-area .item-display')); const itemNamesInArea = itemsInArea.map(item => item.dataset.itemName); formulaList.innerHTML = ''; if (itemNamesInArea.length === 0) { formulaList.innerHTML = '<p class="text-gray-500 text-sm italic">æ”¾å…¥ç‰©å“ä»¥æŸ¥çœ‹ç›¸å…³é…æ–¹...</p>'; return; } const relevantRecipes = mockSynthesisRecipes.filter(recipe => itemNamesInArea.every(itemNameInArea => recipe.inputs.includes(itemNameInArea)) ); if (relevantRecipes.length > 0) { relevantRecipes.forEach(recipe => { const formulaEl = document.createElement('div'); formulaEl.classList.add('formula-item'); formulaEl.innerHTML = ` <span>${recipe.inputs.join(' + ')}</span> <span class="mx-1">â†’</span> <span>${recipe.output.name} (${recipe.probability}%)</span>`; formulaList.appendChild(formulaEl); }); } else { formulaList.innerHTML = '<p class="text-gray-500 text-sm italic">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„é…æ–¹ã€‚</p>'; } }
        /**
         * @description æ˜¾ç¤ºåˆæˆç»“æœä¿¡æ¯ (ä¿æŒä¸å˜)
         * @function showSynthesisResult
         * @param {string} text - æ–‡æœ¬
         * @param {string} colorClass - é¢œè‰²ç±»
         * @returns {void} - æ— è¿”å›å€¼
         */
        function showSynthesisResult(text, colorClass) { const resultText = document.getElementById('synthesis-result-text'); if (resultText) { resultText.textContent = text; resultText.className = `text-center text-sm font-medium h-6 my-2 ${colorClass}`; setTimeout(() => { if (resultText) resultText.textContent = ''; }, 3000); } }
        /**
         * @description ç”Ÿæˆæˆ˜æ–—å¼¹çª— HTML (ä¿æŒä¸å˜)
         * @function generateBattleModal
         * @param {string} enemyType - æ•Œäººç±»å‹
         * @returns {string} - HTML å­—ç¬¦ä¸²
         */
        function generateBattleModal(enemyType) { const player = mockCharacterData; const enemy = { name: enemyType === 'slime' ? 'å²è±å§†' : (enemyType === 'goblin' ? 'å“¥å¸ƒæ—' : 'æœªçŸ¥æ•Œäºº'), icon: enemyType === 'slime' ? 'fas fa-tint' : (enemyType === 'goblin' ? 'fas fa-hat-wizard' : 'fas fa-question'), hp: enemyType === 'slime' ? 30 : (enemyType === 'goblin' ? 50 : 40), maxHp: enemyType === 'slime' ? 30 : (enemyType === 'goblin' ? 50 : 40), color: enemyType === 'slime' ? 'text-green-700 bg-green-200' : (enemyType === 'goblin' ? 'text-yellow-800 bg-yellow-200' : 'text-gray-700 bg-gray-200'), level: enemyType === 'slime' ? 1 : (enemyType === 'goblin' ? 3 : 2), str: enemyType === 'slime' ? 5 : (enemyType === 'goblin' ? 8 : 6), dex: enemyType === 'slime' ? 8 : (enemyType === 'goblin' ? 10 : 7), con: enemyType === 'slime' ? 10 : (enemyType === 'goblin' ? 9 : 8), description: enemyType === 'slime' ? 'ä¸€å›¢é»ç³Šç³Šçš„ç”Ÿç‰©ã€‚' : (enemyType === 'goblin' ? 'ç‹¡çŒ¾çš„å°å‹ç±»äººç”Ÿç‰©ã€‚' : 'ç¥ç§˜çš„å¯¹æ‰‹ã€‚') }; window.currentEnemyData = enemy; return ` <div class="battle-modal-layout"> <div class="battle-left-column"> <div class="battle-area"> <h4 class="text-lg font-semibold mb-3 text-center text-red-600">æ•Œäºº</h4> <div class="battle-unit"> <div class="battle-unit-avatar ${enemy.color}" onclick="openModal('enemy_details', { enemyData: window.currentEnemyData })" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"> <i class="${enemy.icon}"></i> </div> <div class="battle-unit-info"> <div class="font-semibold text-md">${enemy.name}</div> <div class="text-xs text-gray-600">ç”Ÿå‘½å€¼:</div> <div class="progress-bar-container mt-1"> <div id="enemy-hp-bar" class="progress-bar progress-bar-hp" style="width: ${Math.round(enemy.hp / enemy.maxHp * 100)}%;">${enemy.hp}/${enemy.maxHp}</div> </div> </div> </div> </div> <div class="battle-area"> <h4 class="text-lg font-semibold mb-3 text-center text-blue-600">ç©å®¶</h4> <div class="battle-unit"> <div class="battle-unit-avatar bg-blue-200 text-blue-700"> <i class="fas fa-user"></i> </div> <div class="battle-unit-info"> <div class="font-semibold text-md">${player.name}</div> <div class="text-xs text-gray-600">ç”Ÿå‘½å€¼:</div> <div class="progress-bar-container mt-1"> <div id="player-battle-hp-bar" class="progress-bar progress-bar-hp" style="width: ${Math.round(player.hp / player.maxHp * 100)}%;">${player.hp}/${player.maxHp}</div> </div> <div class="text-xs text-gray-600 mt-1">æ³•åŠ›å€¼:</div> <div class="progress-bar-container mt-1"> <div id="player-battle-mp-bar" class="progress-bar progress-bar-mp" style="width: ${Math.round(player.mp / player.maxMp * 100)}%;">${player.mp}/${player.maxMp}</div> </div> </div> </div> </div> </div> <div class="battle-right-column"> <h4 class="text-lg font-semibold mb-2 text-gray-700">æˆ˜æ–—è®°å½•</h4> <div id="battle-log" class="battle-log"> <p class="log-system">æˆ˜æ–—å¼€å§‹ï¼</p> <p class="log-enemy">${enemy.name} å‘èµ·äº†æ”»å‡»ï¼</p> <p class="log-player">ä½ å—åˆ°äº† 5 ç‚¹ä¼¤å®³ã€‚</p> </div> <div class="battle-skills"> <button class="btn btn-danger" onclick="battleAction('attack')"><i class="fas fa-sword mr-1"></i> æ”»å‡»</button> <button class="btn btn-primary" onclick="battleAction('skill_fireball')"><i class="fas fa-magic mr-1"></i> ç«çƒæœ¯ (5MP)</button> <button class="btn btn-blue" onclick="battleAction('defend')"><i class="fas fa-shield-alt mr-1"></i> é˜²å¾¡</button> <button class="btn btn-success" onclick="battleAction('item_potion')"><i class="fas fa-flask mr-1"></i> æ²»ç–—è¯æ°´</button> <button class="btn btn-secondary" onclick="battleAction('flee')"><i class="fas fa-running mr-1"></i> é€ƒè·‘</button> </div> </div> </div>`; }
        /**
         * @description åˆå§‹åŒ–æˆ˜æ–—å¼¹çª— (ä¿æŒä¸å˜)
         * @function initializeBattleModal
         * @returns {void} - æ— è¿”å›å€¼
         */
        function initializeBattleModal() { console.log("æˆ˜æ–—å¼¹çª—å·²åˆå§‹åŒ–"); const battleLog = document.getElementById('battle-log'); if (battleLog) { battleLog.scrollTop = battleLog.scrollHeight; } }
        /**
         * @description å¤„ç†æˆ˜æ–—è¡ŒåŠ¨ (ä¿æŒä¸å˜)
         * @function battleAction
         * @param {string} actionId - è¡ŒåŠ¨ ID
         * @returns {void} - æ— è¿”å›å€¼
         */
        function battleAction(actionId) { const battleLog = document.getElementById('battle-log'); if (!battleLog || !window.currentEnemyData) return; let playerActionText = '', enemyActionText = '', systemText = ''; switch(actionId) { case 'attack': playerActionText = `ä½ å¯¹ ${window.currentEnemyData.name} å‘åŠ¨äº†æ”»å‡»ï¼`; const playerDamage = Math.floor(Math.random() * 5) + 3; enemyActionText = `${window.currentEnemyData.name} å—åˆ°äº† ${playerDamage} ç‚¹ä¼¤å®³ã€‚`; window.currentEnemyData.hp = Math.max(0, window.currentEnemyData.hp - playerDamage); const enemyHpBar = document.getElementById('enemy-hp-bar'); if (enemyHpBar) { const percent = Math.round(window.currentEnemyData.hp / window.currentEnemyData.maxHp * 100); enemyHpBar.style.width = `${percent}%`; enemyHpBar.textContent = `${window.currentEnemyData.hp}/${window.currentEnemyData.maxHp}`; if (window.currentEnemyData.hp === 0) { systemText = `${window.currentEnemyData.name} è¢«å‡»è´¥äº†ï¼æˆ˜æ–—ç»“æŸã€‚`; document.querySelectorAll('.battle-skills button').forEach(btn => btn.disabled = true); setTimeout(closeModal, 2000); } } break; case 'skill_fireball': playerActionText = `ä½ å’å”±å’’è¯­ï¼Œé‡Šæ”¾äº†ç«çƒæœ¯ï¼`; const manaCost = 5; if (mockCharacterData.mp >= manaCost) { mockCharacterData.mp -= manaCost; const skillDamage = Math.floor(Math.random() * 8) + 5; enemyActionText = `ç«çƒå‡»ä¸­äº† ${window.currentEnemyData.name}ï¼Œé€ æˆ ${skillDamage} ç‚¹ä¼¤å®³ï¼`; const playerMpBar = document.getElementById('player-battle-mp-bar'); if(playerMpBar) { const mpPercent = Math.round(mockCharacterData.mp / mockCharacterData.maxMp * 100); playerMpBar.style.width = `${mpPercent}%`; playerMpBar.textContent = `${mockCharacterData.mp}/${mockCharacterData.maxMp}`; } window.currentEnemyData.hp = Math.max(0, window.currentEnemyData.hp - skillDamage); const enemyHpBarSkill = document.getElementById('enemy-hp-bar'); if (enemyHpBarSkill) { const percent = Math.round(window.currentEnemyData.hp / window.currentEnemyData.maxHp * 100); enemyHpBarSkill.style.width = `${percent}%`; enemyHpBarSkill.textContent = `${window.currentEnemyData.hp}/${window.currentEnemyData.maxHp}`; if (window.currentEnemyData.hp === 0) { systemText = `${window.currentEnemyData.name} è¢«å‡»è´¥äº†ï¼æˆ˜æ–—ç»“æŸã€‚`; document.querySelectorAll('.battle-skills button').forEach(btn => btn.disabled = true); setTimeout(closeModal, 2000); } } } else { enemyActionText = `æ³•åŠ›ä¸è¶³ï¼Œæ–½æ³•å¤±è´¥ï¼`; } break; case 'defend': playerActionText = `ä½ é‡‡å–äº†é˜²å¾¡å§¿æ€ã€‚`; break; case 'item_potion': const potion = mockCharacterData.inventory.find(i => i.id === 'item_potion_heal_s'); if (potion && potion.count > 0) { playerActionText = `ä½ ä½¿ç”¨äº†[æ²»ç–—è¯æ°´(å°)]ã€‚`; const healAmount = Math.floor(Math.random() * 10) + 10; mockCharacterData.hp = Math.min(mockCharacterData.maxHp, mockCharacterData.hp + healAmount); potion.count -= 1; if (potion.count === 0) { mockCharacterData.inventory = mockCharacterData.inventory.filter(i => i.id !== 'item_potion_heal_s'); } enemyActionText = `ä½ æ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼ã€‚`; updateInventoryUI(); const playerHpBar = document.getElementById('player-battle-hp-bar'); if(playerHpBar) { const hpPercent = Math.round(mockCharacterData.hp / mockCharacterData.maxHp * 100); playerHpBar.style.width = `${hpPercent}%`; playerHpBar.textContent = `${mockCharacterData.hp}/${mockCharacterData.maxHp}`; } } else { playerActionText = `ä½ è¯•å›¾ä½¿ç”¨è¯æ°´ï¼Œä½†å‘ç°èƒŒåŒ…é‡Œæ²¡æœ‰äº†ï¼`; } break; case 'flee': playerActionText = `ä½ å°è¯•é€ƒè·‘...`; if (Math.random() < 0.7) { systemText = 'é€ƒè·‘æˆåŠŸï¼æˆ˜æ–—ç»“æŸã€‚'; document.querySelectorAll('.battle-skills button').forEach(btn => btn.disabled = true); setTimeout(closeModal, 1500); } else { enemyActionText = 'é€ƒè·‘å¤±è´¥ï¼'; } break; } if (playerActionText) { const p = document.createElement('p'); p.classList.add('log-player'); p.textContent = playerActionText; battleLog.appendChild(p); } if (enemyActionText) { const p = document.createElement('p'); p.classList.add('log-enemy'); p.textContent = enemyActionText; battleLog.appendChild(p); } if (systemText) { const p = document.createElement('p'); p.classList.add('log-system'); p.textContent = systemText; battleLog.appendChild(p); } battleLog.scrollTop = battleLog.scrollHeight; updateCharacterUI(); }

        // --- æŠ˜å åŠŸèƒ½ (ä¿æŒä¸å˜) ---
        // ... (toggleCollapse ä¿æŒä¸å˜) ...
        function toggleCollapse(sectionId) { if (sectionId === 'status' || sectionId === 'inventory') return; const content = document.getElementById(`${sectionId}-content`); const header = content?.previousElementSibling; const icon = header?.querySelector('.collapsible-icon'); if (content && header && icon) { collapseState[sectionId] = !collapseState[sectionId]; if (collapseState[sectionId]) { content.classList.remove('expanded'); header.classList.remove('expanded'); } else { content.classList.add('expanded'); header.classList.add('expanded'); } } else { console.warn(`æ— æ³•æ‰¾åˆ°åŒºåŸŸ ${sectionId} çš„ content, header æˆ– icon å…ƒç´ ã€‚`); } }

        // --- UI æ›´æ–° (éƒ¨åˆ†ä¿®æ”¹) ---
        /**
         * @description æ›´æ–°è§’è‰²çŠ¶æ€é¢æ¿ (ä¿æŒä¸å˜)
         * @function updateCharacterUI
         * @returns {void} - æ— è¿”å›å€¼
         */
        function updateCharacterUI() { if (!hpBar || !mpBar || !attributesSummary || !identitySummary || !statusContent || !equipmentContent || !inventoryList || !inventorySummary) { console.warn("è§’è‰² UI å…ƒç´ å°šæœªå®Œå…¨å‡†å¤‡å¥½ (updateCharacterUI)ã€‚"); return; } const char = mockCharacterData; hpBar.style.width = `${Math.round(char.hp / char.maxHp * 100)}%`; hpBar.textContent = `${char.hp}/${char.maxHp}`; mpBar.style.width = `${Math.round(char.mp / char.maxMp * 100)}%`; mpBar.textContent = `${char.mp}/${char.maxMp}`; document.getElementById('attr-str').textContent = char.str; document.getElementById('attr-dex').textContent = char.dex; document.getElementById('attr-con').textContent = char.con; document.getElementById('attr-int').textContent = char.int; document.getElementById('attr-wis').textContent = char.wis; document.getElementById('attr-cha').textContent = char.cha; attributesSummary.textContent = `åŠ› ${char.str} æ• ${char.dex} ä½“ ${char.con} æ™º ${char.int} æ„Ÿ ${char.wis} é­… ${char.cha}`; document.getElementById('info-name').textContent = char.name; document.getElementById('info-faction').textContent = char.faction; document.getElementById('info-identity').textContent = char.identity.join(', '); identitySummary.textContent = char.name; const statusContainer = statusContent.querySelector('.flex'); if (statusContainer) { statusContainer.innerHTML = char.status.map(s => ` <div class="status-item tooltip" data-status-id="${s.id}"> <span class="status-text ${s.positive ? (Math.random() < 0.5 ? 'status-positive-alt' : 'status-positive') : 'status-negative'}"> <i class="${s.icon} mr-1"></i>${s.name} (${s.type}) </span> <span class="tooltiptext">${s.desc}</span> </div>`).join(''); } else { console.error("æœªæ‰¾åˆ°çŠ¶æ€æ•ˆæœå®¹å™¨ï¼"); } const equipmentContainer = equipmentContent.querySelector('.grid'); if (equipmentContainer) { equipmentContainer.innerHTML = Object.entries(char.equipment).map(([slot, item]) => { const iconMap = { weapon: 'fas fa-shield-alt', armor: 'fas fa-tshirt', accessory: 'fas fa-ring', head: 'fas fa-hat-wizard', feet: 'fas fa-shoe-prints'}; const slotNameMap = { weapon: 'æ­¦å™¨', armor: 'æŠ¤ç”²', accessory: 'é¥°å“', head: 'å¤´éƒ¨', feet: 'è„šéƒ¨'}; const isEmpty = !item; return ` <div class="equipment-item tooltip" data-equip-id="${item?.id || `empty_${slot}`}"> <div class="stat-item ${isEmpty ? 'text-gray-400' : ''}"> <span class="stat-label"><i class="${iconMap[slot] || 'fas fa-question'} w-4 text-center mr-1"></i>${slotNameMap[slot] || slot}</span> <span class="stat-value">${item ? item.name : '[ç©º]'}</span> </div> <span class="tooltiptext">${item ? `${item.name}<br>${item.desc}` : `${slotNameMap[slot] || slot}<br>æ— è£…å¤‡`}</span> </div>`; }).join(''); } else { console.error("æœªæ‰¾åˆ°è£…å¤‡å®¹å™¨ï¼"); } updateInventoryUI(); Object.keys(collapseState).forEach(id => { if (id === 'status' || id === 'inventory') return; const content = document.getElementById(`${id}-content`); const header = content?.previousElementSibling; if (content && header) { const icon = header.querySelector('.collapsible-icon'); if (icon) { if (collapseState[id]) { content.classList.remove('expanded'); header.classList.remove('expanded'); } else { content.classList.add('expanded'); header.classList.add('expanded'); } } } }); }
        /**
         * @description æ›´æ–°ç‰©å“æ  UI (ä¿æŒä¸å˜)
         * @function updateInventoryUI
         * @returns {void} - æ— è¿”å›å€¼
         */
        function updateInventoryUI() { if (!inventoryList || !inventorySummary) { return; } inventoryList.innerHTML = ''; const char = mockCharacterData; const currentSlotCount = char.inventory.length; inventorySummary.textContent = `${currentSlotCount} / ${char.inventoryCapacity}`; char.inventory.forEach(item => { const itemEl = document.createElement('div'); itemEl.classList.add('item-display', 'tooltip'); itemEl.dataset.itemId = item.id; itemEl.innerHTML = ` <div class="item-icon"> <i class="${item.icon || 'fas fa-box'}"></i> ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''} </div> <span class="item-name">${item.name}</span> <span class="tooltiptext">${item.name}<br>${item.desc}</span>`; inventoryList.appendChild(itemEl); }); const emptySlots = char.inventoryCapacity - currentSlotCount; for (let i = 0; i < emptySlots; i++) { const emptyEl = document.createElement('div'); emptyEl.classList.add('item-display', 'cursor-default'); emptyEl.innerHTML = ` <div class="item-icon bg-gray-100 border-gray-200"></div> <span class="item-name text-transparent">.</span>`; inventoryList.appendChild(emptyEl); } }

        // --- èœå•æ ä¸ç®¡ç†å‘˜æ¨¡å¼åŠŸèƒ½ (æ–°å¢/ä¿®æ”¹) ---
        /**
         * @description åˆ‡æ¢è®¾ç½®ä¸‹æ‹‰èœå•çš„æ˜¾ç¤ºçŠ¶æ€
         * @function toggleSettingsDropdown
         * @returns {void} - æ— è¿”å›å€¼
         */
        function toggleSettingsDropdown() {
            settingsDropdownContent.classList.toggle("show");
        }

        /**
         * @description å¤„ç†èœå•é¡¹ç‚¹å‡»äº‹ä»¶
         * @function handleMenuClick
         * @param {string} action - ç‚¹å‡»çš„èœå•é¡¹æ ‡è¯†
         * @returns {void} - æ— è¿”å›å€¼
         */
        function handleMenuClick(action) {
            console.log("èœå•é¡¹è¢«ç‚¹å‡»:", action);
            // å…³é—­ä¸‹æ‹‰èœå•
            if (settingsDropdownContent.classList.contains('show')) {
                settingsDropdownContent.classList.remove('show');
            }

            if (action === 'admin_mode') {
                // æ‰“å¼€ç®¡ç†å‘˜æ¨¡å¼é€‰æ‹©å¼¹çª—
                openModal('admin');
            } else {
                // å…¶ä»–èœå•é¡¹çš„å ä½é€»è¾‘
                alert(`ä½ ç‚¹å‡»äº† "${action}" åŠŸèƒ½ (å°šæœªå®ç°)`);
            }
        }

        /**
         * @description ç”Ÿæˆç®¡ç†å‘˜æ¨¡å¼é€‰æ‹©å¼¹çª—çš„ HTML
         * @function generateAdminModal
         * @returns {string} - HTML å­—ç¬¦ä¸²
         */
        function generateAdminModal() {
            return `
                <button class="modal-close-btn" onclick="closeModal()">&times;</button>
                <h3 class="modal-title">ç®¡ç†å‘˜æ¨¡å¼</h3>
                <div class="space-y-3">
                    <button class="btn btn-primary w-full" onclick="loadAdminPage('item_management.html', 'ç‰©å“ç®¡ç†')">ç‰©å“ç®¡ç†</button>
                    <button class="btn btn-primary w-full" onclick="loadAdminPage('creature_management.html', 'ç”Ÿç‰©ç®¡ç†')">ç”Ÿç‰©ç®¡ç†</button>
                    <button class="btn btn-primary w-full" onclick="loadAdminPage('event_management.html', 'äº‹ä»¶ç®¡ç†')">äº‹ä»¶ç®¡ç†</button>
                    <button class="btn btn-primary w-full" onclick="loadAdminPage('map_management.html', 'åœ°å›¾ç®¡ç†')">åœ°å›¾ç®¡ç†</button>
                </div>
                <div class="mt-6 text-right">
                    <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            `;
        }

        /**
         * @description åˆå§‹åŒ–ç®¡ç†å‘˜æ¨¡å¼å¼¹çª—ï¼ˆå¦‚æœéœ€è¦ï¼‰
         * @function initializeAdminModal
         * @returns {void} - æ— è¿”å›å€¼
         */
        function initializeAdminModal() {
            console.log("ç®¡ç†å‘˜æ¨¡å¼å¼¹çª—å·²åˆå§‹åŒ–");
            // ç›®å‰ä¸éœ€è¦ç‰¹æ®Šåˆå§‹åŒ–é€»è¾‘
        }

        /**
         * @description å¼‚æ­¥åŠ è½½å¹¶æ˜¾ç¤ºæŒ‡å®šçš„ç®¡ç†é¡µé¢
         * @async
         * @function loadAdminPage
         * @param {string} pageUrl - è¦åŠ è½½çš„ HTML æ–‡ä»¶è·¯å¾„
         * @param {string} title - ç®¡ç†é¡µé¢çš„æ ‡é¢˜
         * @returns {Promise<void>} - æ— è¿”å›å€¼
         */
        async function loadAdminPage(pageUrl, title) {
            console.log(`å°è¯•åŠ è½½ç®¡ç†é¡µé¢: ${pageUrl}`);
            closeModal(); // å…³é—­ç®¡ç†å‘˜é€‰æ‹©å¼¹çª—

            const mainContainer = document.querySelector('.main-container');
            const topMenuBar = document.querySelector('.top-menu-bar');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            adminPageContent.innerHTML = '<p class="text-gray-500 italic">æ­£åœ¨åŠ è½½ç®¡ç†é¡µé¢...</p>';
            adminPageTitle.textContent = title;
            if (mainContainer) mainContainer.style.display = 'none'; // éšè—ä¸»æ¸¸æˆç•Œé¢
            if (topMenuBar) topMenuBar.style.display = 'none'; // éšè—é¡¶éƒ¨èœå•æ 
            adminPageOverlay.classList.add('active'); // æ˜¾ç¤ºè¦†ç›–å±‚

            try {
                const response = await fetch(pageUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pageContent = await response.text();
                adminPageContent.innerHTML = pageContent; // å°†åŠ è½½çš„å†…å®¹æ³¨å…¥
                console.log(`${pageUrl} åŠ è½½æˆåŠŸ`);
                // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡ŒåŠ è½½é¡µé¢çš„åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // ä¾‹å¦‚: if (pageUrl === 'item_management.html') { initializeItemManagement(); }

            } catch (error) {
                console.error('åŠ è½½ç®¡ç†é¡µé¢å¤±è´¥:', error);
                adminPageContent.innerHTML = `<p class="text-red-500 font-semibold">åŠ è½½é¡µé¢å¤±è´¥: ${error.message}</p><p>è¯·ç¡®ä¿æ–‡ä»¶ '${pageUrl}' å­˜åœ¨äºæ­£ç¡®çš„è·¯å¾„ä¸‹ã€‚</p>`;
            }
        }

        /**
         * @description éšè—ç®¡ç†é¡µé¢è¦†ç›–å±‚ï¼Œæ˜¾ç¤ºä¸»æ¸¸æˆç•Œé¢
         * @function hideAdminPage
         * @returns {void} - æ— è¿”å›å€¼
         */
        function hideAdminPage() {
            const mainContainer = document.querySelector('.main-container');
            const topMenuBar = document.querySelector('.top-menu-bar');

            adminPageOverlay.classList.remove('active'); // éšè—è¦†ç›–å±‚
            if (mainContainer) mainContainer.style.display = 'flex'; // æ¢å¤ä¸»æ¸¸æˆç•Œé¢æ˜¾ç¤º
            if (topMenuBar) topMenuBar.style.display = 'flex'; // æ¢å¤é¡¶éƒ¨èœå•æ æ˜¾ç¤º
            adminPageContent.innerHTML = ''; // æ¸…ç©ºå†…å®¹
            console.log("è¿”å›æ¸¸æˆç•Œé¢");
        }


        // --- åˆå§‹åŒ– ---
        /**
         * @description DOM åŠ è½½å®Œæˆåæ‰§è¡Œçš„åˆå§‹åŒ–å‡½æ•°
         * @event DOMContentLoaded
         */
        document.addEventListener('DOMContentLoaded', () => {
            // è·å–æ‰€æœ‰éœ€è¦çš„ DOM å…ƒç´ å¼•ç”¨
            hpBar = document.getElementById('hp-bar');
            mpBar = document.getElementById('mp-bar');
            mapGrid = document.getElementById('map-grid');
            tileInfoCoords = document.getElementById('current-coords');
            tileInfoTerrain = document.getElementById('current-terrain');
            tileInfoWeather = document.getElementById('current-weather');
            eventDescription = document.getElementById('event-description');
            eventOptions = document.getElementById('event-options');
            eventResult = document.getElementById('event-result');
            modalOverlay = document.getElementById('modal-overlay');
            detailsBtn = document.getElementById('details-btn');
            synthesisBtn = document.getElementById('synthesis-btn');
            inventoryList = document.getElementById('inventory-list');
            inventorySummary = document.getElementById('inventory-summary');
            attributesSection = document.getElementById('attributes-section');
            attributesContent = document.getElementById('attributes-content');
            attributesSummary = document.getElementById('attributes-summary');
            identitySection = document.getElementById('identity-section');
            identityContent = document.getElementById('identity-content');
            identitySummary = document.getElementById('identity-summary');
            statusSection = document.getElementById('status-section');
            statusContent = document.getElementById('status-content');
            equipmentSection = document.getElementById('equipment-section');
            equipmentContent = document.getElementById('equipment-content');
            inventorySection = document.getElementById('inventory-section');
            inventoryContent = document.getElementById('inventory-content');
            settingsBtn = document.getElementById('settings-btn');
            settingsDropdownContent = document.getElementById('settings-dropdown-content');
            adminPageOverlay = document.getElementById('admin-page-overlay'); // è·å–è¦†ç›–å±‚
            adminPageTitle = document.getElementById('admin-page-title');   // è·å–è¦†ç›–å±‚æ ‡é¢˜
            adminPageContent = document.getElementById('admin-page-content'); // è·å–è¦†ç›–å±‚å†…å®¹åŒºåŸŸ
            adminBackBtn = document.getElementById('admin-back-btn');       // è·å–è¿”å›æŒ‰é’®

            // åˆå§‹æ¸²æŸ“ UI
            renderMap();
            updateCharacterUI();
            triggerEvent(currentPlayerPos.x, currentPlayerPos.y);

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            if (detailsBtn) detailsBtn.addEventListener('click', () => openModal('details'));
            if (synthesisBtn) synthesisBtn.addEventListener('click', () => openModal('synthesis'));
            if (settingsBtn) settingsBtn.addEventListener('click', toggleSettingsDropdown);
            if (adminBackBtn) adminBackBtn.addEventListener('click', hideAdminPage); // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶

            // ç‚¹å‡»çª—å£å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
            window.onclick = function(event) {
                if (!event.target.matches('.settings-button') && !event.target.closest('.settings-button')) {
                    if (settingsDropdownContent && settingsDropdownContent.classList.contains('show')) {
                        settingsDropdownContent.classList.remove('show');
                    }
                }
                // ç‚¹å‡»å¼¹çª—å¤–éƒ¨ä¸å…³é—­ (ç”± closeModalOnClickOutside å¤„ç†)
            }

            console.log("æ¸¸æˆ UI Demo (v15 - ç®¡ç†å‘˜æ¨¡å¼å…¥å£) åˆå§‹åŒ–å®Œæˆã€‚");
        });

    </script>

</body>
</html>
