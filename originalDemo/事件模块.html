<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‹ä»¶ç®¡ç†æ¨¡å— v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: flex;
            height: calc(100vh - 100px); /* Adjust height based on top bar */
            gap: 1rem; /* gap-4 */
        }
        .left-panel {
            width: 30%;
            min-width: 250px;
            background-color: white;
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            display: flex;
            flex-direction: column;
            overflow-y: hidden; /* Prevent panel scroll, list scrolls */
        }
        .right-panel {
            width: 70%;
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            overflow-y: auto; /* Allow scrolling for long event details */
        }
        .top-bar {
            padding: 1rem;
            background-color: white;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        /* å·¦ä¾§åˆ—è¡¨ */
        .event-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem; /* mt-4 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .event-list-item {
            padding: 0.75rem 1rem; /* p-3 px-4 */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .event-list-item:last-child {
            border-bottom: none;
        }
        .event-list-item:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .event-list-item.selected {
            background-color: #dbeafe; /* blue-100 */
            font-weight: 600; /* font-semibold */
        }
        .event-list-item .event-name {
            flex-grow: 1;
            margin-right: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-list-item .event-actions button {
            margin-left: 0.5rem; /* ml-2 */
            padding: 0.1rem 0.4rem;
            font-size: 0.75rem; /* text-xs */
            border-radius: 0.25rem; /* rounded-sm */
        }
        /* å³ä¾§è¡¨å• */
        .form-section {
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .form-section h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            margin-bottom: 0.75rem; /* mb-3 */
            color: #374151; /* gray-700 */
        }
        .form-label {
            display: block;
            font-weight: 500; /* font-medium */
            margin-bottom: 0.25rem; /* mb-1 */
            color: #4b5563; /* gray-600 */
            font-size: 0.875rem; /* text-sm */
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.5rem; /* p-2 */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #60a5fa; /* blue-400 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); /* focus:ring-blue-300 */
        }
        .form-textarea {
            min-height: 80px;
        }
        .form-checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #374151;
        }
        .form-checkbox {
            margin-right: 0.5rem; /* mr-2 */
            height: 1rem; /* h-4 */
            width: 1rem; /* w-4 */
        }
        /* é€‰é¡¹åˆ—è¡¨ */
        .options-list {
            margin-top: 1rem; /* mt-4 */
            border-top: 1px solid #e5e7eb; /* border-gray-200 */
            padding-top: 1rem; /* pt-4 */
        }
        .option-item {
            background-color: #f9fafb; /* gray-50 */
            padding: 1rem; /* p-4 */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .option-item h4 {
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem; /* mb-2 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .option-item h4 .option-id {
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
            font-weight: normal;
        }
        .option-details p {
            margin-bottom: 0.5rem; /* mb-2 */
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* gray-600 */
            word-break: break-all; /* Prevent long IDs/code from breaking layout */
        }
        .option-details strong {
            color: #1f2937; /* gray-800 */
            margin-right: 0.25rem;
        }
        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* JS control */
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem; /* p-8 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            width: 90%;
            max-width: 700px; /* Wider modal for options */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem; /* top-3 */
            right: 1rem; /* right-4 */
            font-size: 1.5rem; /* text-2xl */
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .modal-close-btn:hover {
            color: #374151; /* gray-700 */
        }
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        /* ç®€å•çš„æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .btn-primary { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; border-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-success { background-color: #10b981; color: white; border-color: #10b981; }
        .btn-success:hover { background-color: #059669; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

    </style>
</head>
<body>

    <div class="top-bar">
        <button id="import-events-btn" class="btn btn-secondary">å¯¼å…¥äº‹ä»¶</button>
        <input type="file" id="import-events-file" accept=".json" style="display: none;">
        <button id="export-events-btn" class="btn btn-success">å¯¼å‡ºäº‹ä»¶</button>
    </div>

    <div class="main-layout">
        <div class="left-panel">
            <button id="new-event-btn" class="btn btn-primary w-full mb-4">æ–°å»ºäº‹ä»¶</button>
            <input type="text" id="search-event-input" placeholder="æœç´¢äº‹ä»¶åç§°..." class="form-input mb-2">
            <select id="filter-event-select" class="form-select mb-4">
                <option value="all">æŸ¥çœ‹å…¨éƒ¨äº‹ä»¶</option>
                <option value="root">åªæŸ¥çœ‹æ ¹äº‹ä»¶</option>
                <option value="common">åªæŸ¥çœ‹å…¬å…±äº‹ä»¶</option>
            </select>
            <div id="event-list" class="event-list-container">
                <p class="p-4 text-gray-500 italic">æš‚æ— äº‹ä»¶</p>
            </div>
        </div>

        <div class="right-panel" id="event-editor-panel" style="display: none;"> <form id="event-form">
                <input type="hidden" id="event-id"> <div class="form-section grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="event-name" class="form-label">äº‹ä»¶åç§°:</label>
                        <input type="text" id="event-name" class="form-input" required>
                    </div>
                    <div>
                        <label for="event-type" class="form-label">äº‹ä»¶ç±»å‹:</label>
                        <select id="event-type" class="form-select">
                            <option value="normal">æ™®é€šäº‹ä»¶</option>
                            <option value="combat">æˆ˜æ–—äº‹ä»¶</option>
                            <option value="common">å…¬å…±äº‹ä»¶</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-4">
                         <label class="form-checkbox-label">
                            <input type="checkbox" id="event-is-root" class="form-checkbox">
                            æ˜¯å¦æ ¹äº‹ä»¶ (æ•…äº‹èµ·ç‚¹)
                        </label>
                    </div>
                </div>


                <div class="form-section grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="event-preconditions" class="form-label">å‰ç½®æ¡ä»¶ (JSä»£ç , è¿”å› true è§¦å‘):</label>
                        <textarea id="event-preconditions" class="form-textarea" rows="3" placeholder="ä¾‹å¦‚: characterData.attributes['åŠ›é‡'].total >= 15 && characterData.inventory.has('key-item-id')"></textarea>
                    </div>
                    <div>
                        <label for="event-mutex-conditions" class="form-label">äº’æ–¥æ¡ä»¶ (JSä»£ç , è¿”å› true ä¸è§¦å‘):</label>
                        <textarea id="event-mutex-conditions" class="form-textarea" rows="3" placeholder="ä¾‹å¦‚: characterData.status.some(s => s.name === 'å·²å®ŒæˆæŸä»»åŠ¡')"></textarea>
                    </div>
                </div>

                 <div class="form-section grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="event-time" class="form-label">æ—¶é—´é™åˆ¶ (é€—å·åˆ†éš”, ç•™ç©ºä¸é™):</label>
                        <input type="text" id="event-time" class="form-input" placeholder="ç™½å¤©,å¤œæ™š,ä¸Šåˆ,ä¸‹åˆ,é»„æ˜">
                    </div>
                     <div>
                        <label for="event-location" class="form-label">åœ°ç‚¹é™åˆ¶ (é€—å·åˆ†éš”, ç•™ç©ºä¸é™):</label>
                        <input type="text" id="event-location" class="form-input" placeholder="è’é‡,æµ·æ´‹,åŸå¸‚,æ£®æ—">
                    </div>
                     <div>
                        <label for="event-weather" class="form-label">å¤©æ°”é™åˆ¶ (é€—å·åˆ†éš”, ç•™ç©ºä¸é™):</label>
                        <input type="text" id="event-weather" class="form-input" placeholder="æ™´å¤©,å¤§é›¨,æš´é£é›¨">
                    </div>
                 </div>


                <div class="form-section">
                    <label for="event-visible-desc" class="form-label">å¯è§æè¿° (ç©å®¶ç›´æ¥çœ‹åˆ°):</label>
                    <textarea id="event-visible-desc" class="form-textarea" rows="4" required></textarea>
                </div>

                <div class="form-section">
                    <label for="event-conditional-desc" class="form-label">æ¡ä»¶æè¿° (JSä»£ç , è¿”å›å­—ç¬¦ä¸²æ˜¾ç¤º):</label>
                    <textarea id="event-conditional-desc" class="form-textarea" rows="4" placeholder="æ¯è¡Œä¸€ä¸ªæ¡ä»¶æè¿°, ä¾‹å¦‚:&#10;if (characterData.attributes['æ„ŸçŸ¥'].total >= 13) return 'ä½ æ³¨æ„åˆ°è§’è½é‡Œæœ‰ä¸€ä¸å¾®å…‰ã€‚';&#10;if (characterData.personality.includes('å¥½å¥‡')) return 'ä½ å¿ä¸ä½æƒ³è°ƒæŸ¥ä¸€ä¸‹é‚£ä¸ªå¥‡æ€ªçš„ç¬¦å·ã€‚';"></textarea>
                </div>

                <div class="form-section">
                    <label for="event-hidden-desc" class="form-label">éšè—æè¿° (ä»…ä¾›AIæˆ–å†…éƒ¨å‚è€ƒ):</label>
                    <textarea id="event-hidden-desc" class="form-textarea" rows="3"></textarea>
                </div>

                 <div class="form-section grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="event-visible-creatures" class="form-label">å¯è§ç”Ÿç‰©åˆ—è¡¨ (é€—å·åˆ†éš”):</label>
                        <input type="text" id="event-visible-creatures" class="form-input" placeholder="å“¥å¸ƒæ—,å²è±å§†">
                    </div>
                    <div>
                        <label for="event-hidden-creatures" class="form-label">éšè—ç”Ÿç‰©åˆ—è¡¨ (é€—å·åˆ†éš”):</label>
                        <input type="text" id="event-hidden-creatures" class="form-input" placeholder="æ½œè¡Œçš„åˆºå®¢">
                    </div>
                 </div>

                 <div class="form-section">
                    <label for="event-max-gain" class="form-label">æœ€å¤§æ”¶ç›Šæè¿° (é™åˆ¶AIç”Ÿæˆ):</label>
                    <input type="text" id="event-max-gain" class="form-input" placeholder="å°‘é‡é‡‘å¸, åŸºç¡€è‰è¯, åŠ›é‡ç†Ÿç»ƒåº¦å¾®é‡æå‡">
                 </div>

                <div class="form-section">
                    <h3>é€‰é¡¹ç®¡ç†</h3>
                    <div id="options-list" class="options-list">
                        <p class="text-gray-500 italic">æš‚æ— é€‰é¡¹</p>
                    </div>
                    <button type="button" id="add-option-btn" class="btn btn-success mt-4">æ·»åŠ æ–°é€‰é¡¹</button>
                </div>

                <div class="mt-8 flex justify-end gap-4">
                     <button type="button" id="save-event-btn" class="btn btn-primary">ä¿å­˜äº‹ä»¶</button>
                     <button type="button" id="cancel-edit-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
         <div class="right-panel flex items-center justify-center text-gray-500" id="event-placeholder">
            <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªäº‹ä»¶è¿›è¡ŒæŸ¥çœ‹æˆ–ç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»â€œæ–°å»ºäº‹ä»¶â€ã€‚</p>
        </div>
    </div>

    <div id="option-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="option-modal-close-btn" class="modal-close-btn" title="å…³é—­">&times;</button>
            <h3 id="option-modal-title" class="modal-title">æ·»åŠ æ–°é€‰é¡¹</h3>
            <form id="option-form">
                <input type="hidden" id="option-id"> <input type="hidden" id="option-parent-event-id"> <div class="modal-grid">
                    <div>
                        <label for="option-title" class="form-label">é€‰é¡¹æ ‡é¢˜:</label>
                        <input type="text" id="option-title" class="form-input" required>
                    </div>
                    <div>
                        <label for="option-is-end" class="form-checkbox-label mt-6">
                            <input type="checkbox" id="option-is-end" class="form-checkbox">
                            æ˜¯å¦ç»“æŸäº‹ä»¶
                        </label>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="option-text" class="form-label">é€‰é¡¹æ–‡æœ¬ (ç©å®¶çœ‹åˆ°çš„æè¿°):</label>
                    <textarea id="option-text" class="form-textarea" rows="3" required></textarea>
                </div>

                <div class="mt-4">
                    <label for="option-condition" class="form-label">æ˜¾ç¤ºæ¡ä»¶ (JSä»£ç , è¿”å› true æ˜¾ç¤º):</label>
                    <textarea id="option-condition" class="form-textarea" rows="3" placeholder="ä¾‹å¦‚: characterData.attributes['é­…åŠ›'].total >= 12"></textarea>
                </div>

                <div class="mt-4">
                    <label for="option-probability-display" class="form-label">æ¦‚ç‡æ˜¾ç¤º (JSä»£ç , è¿”å›å­—ç¬¦ä¸²):</label>
                    <textarea id="option-probability-display" class="form-textarea" rows="2" placeholder="ä¾‹å¦‚: return `æˆåŠŸç‡: ${calculateSuccessRate()}%`"></textarea>
                </div>

                <div class="mt-4">
                    <label for="option-function-call" class="form-label">è°ƒç”¨å‡½æ•° (JSä»£ç , è¿”å› true/false):</label>
                    <textarea id="option-function-call" class="form-textarea" rows="3" placeholder="ä¾‹å¦‚: return Math.random() < 0.75; // 75% æˆåŠŸç‡"></textarea>
                </div>

                 <div class="mt-4 modal-grid">
                    <div>
                        <label for="option-success-event-id" class="form-label">æˆåŠŸåè·³è½¬äº‹ä»¶:</label>
                        <select id="option-success-event-id" class="form-select">
                            <option value="">-- æ— è·³è½¬ --</option>
                            </select>
                    </div>
                    <div>
                        <label for="option-failure-event-id" class="form-label">å¤±è´¥åè·³è½¬äº‹ä»¶:</label>
                        <select id="option-failure-event-id" class="form-select">
                             <option value="">-- æ— è·³è½¬ --</option>
                             </select>
                    </div>
                 </div>

                 <div class="mt-4">
                     <label for="option-result-effects" class="form-label">ç›´æ¥ç»“æœæ•ˆæœ (JSONæ ¼å¼):</label>
                     <textarea id="option-result-effects" class="form-textarea" rows="4" placeholder='[{"type": "add_item", "id": "gold", "count": 10}, {"type": "change_proficiency", "attr": "åŠ›é‡", "amount": 5}, {"type": "add_status", "name": "ç–²æƒ«", "statusType": "temporary"}]'></textarea>
                     <p class="text-xs text-gray-500 mt-1">ç±»å‹: add_item, remove_item, change_proficiency, add_status, remove_status, change_alignment, modify_resource, add_background</p>
                 </div>


                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="option-modal-cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" id="option-modal-save-btn" class="btn btn-primary">ä¿å­˜é€‰é¡¹</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- å…¨å±€å˜é‡ä¸çŠ¶æ€ ---
        /** @type {Map<string, object>} å­˜å‚¨æ‰€æœ‰äº‹ä»¶æ•°æ®ï¼ŒKey ä¸ºäº‹ä»¶ ID */
        let allEventsData = new Map();
        /** @type {string | null} å½“å‰åœ¨å³ä¾§ç¼–è¾‘æˆ–æŸ¥çœ‹çš„äº‹ä»¶ ID */
        let currentEditingEventId = null;
        /** @type {string | null} å½“å‰æ­£åœ¨ç¼–è¾‘çš„é€‰é¡¹ ID (ç”¨äºåŒºåˆ†æ–°å¢å’Œç¼–è¾‘) */
        let currentEditingOptionId = null;
        /** @type {'all' | 'root' | 'common'} å½“å‰å·¦ä¾§åˆ—è¡¨çš„ç­›é€‰ç±»å‹ */
        let currentEventFilter = 'all';
        /** @type {string} å½“å‰å·¦ä¾§åˆ—è¡¨çš„æœç´¢å…³é”®è¯ */
        let currentSearchTerm = '';

        // --- äº‹ä»¶æ•°æ®ç»“æ„ (ç¤ºä¾‹) ---
        /*
        const exampleEvent = {
            id: "evt_start_forest", // äº‹ä»¶å”¯ä¸€ ID
            name: "æ£®æ—å…¥å£", // äº‹ä»¶åç§°
            type: "normal", // äº‹ä»¶ç±»å‹: normal, combat, common
            isRoot: true, // æ˜¯å¦æ˜¯æ ¹äº‹ä»¶ (æ•…äº‹èµ·ç‚¹)
            preconditions: "", // JS ä»£ç ï¼Œè¿”å› true è§¦å‘
            mutexConditions: "", // JS ä»£ç ï¼Œè¿”å› true ä¸è§¦å‘
            time: ["ç™½å¤©"], // æ—¶é—´é™åˆ¶åˆ—è¡¨
            location: ["æ£®æ—"], // åœ°ç‚¹é™åˆ¶åˆ—è¡¨
            weather: [], // å¤©æ°”é™åˆ¶åˆ—è¡¨
            visibleDesc: "ä½ ç«™åœ¨ä¸€ç‰‡èŒ‚å¯†çš„æ£®æ—è¾¹ç¼˜ï¼Œé˜³å…‰é€è¿‡æ ‘å¶æ´’ä¸‹æ–‘é©³çš„å…‰ç‚¹ã€‚ä¸€æ¡å°å¾„èœ¿èœ’ä¼¸å‘æ£®æ—æ·±å¤„ã€‚", // ç©å®¶ç›´æ¥çœ‹åˆ°çš„æè¿°
            conditionalDesc: [ // æ¡ä»¶æè¿°åˆ—è¡¨
                "if (characterData.attributes['æ„ŸçŸ¥'].total >= 12) return 'ä½ ä¼¼ä¹é—»åˆ°ç©ºæ°”ä¸­æœ‰ä¸€ä¸è…è´¥çš„æ°”å‘³ã€‚';",
                "if (characterData.identity.includes('çŒäºº')) return 'ä½ è®¤å‡ºåœ°ä¸Šæœ‰ä¸€äº›åŠ¨ç‰©çš„è¶³è¿¹ã€‚';"
            ],
            hiddenDesc: "è¿™æ¡è·¯é€šå¾€å“¥å¸ƒæ—è¥åœ°ã€‚", // ä»…ä¾›å†…éƒ¨å‚è€ƒ
            visibleCreatures: [], // å¯è§ç”Ÿç‰©åç§°åˆ—è¡¨
            hiddenCreatures: ["å“¥å¸ƒæ—å“¨å…µ"], // éšè—ç”Ÿç‰©åç§°åˆ—è¡¨
            maxGain: "å°‘é‡ç»éªŒï¼Œå¯èƒ½å‘ç°è‰è¯", // AI ç”Ÿæˆæ”¶ç›Šé™åˆ¶æè¿°
            options: { // é€‰é¡¹å¯¹è±¡ï¼ŒKey ä¸ºé€‰é¡¹å”¯ä¸€ ID
                "opt_forest_enter": {
                    id: "opt_forest_enter", // é€‰é¡¹å”¯ä¸€ ID
                    condition: "", // JS ä»£ç ï¼Œè¿”å› true æ˜¾ç¤º
                    title: "è¿›å…¥æ£®æ—", // é€‰é¡¹æ ‡é¢˜
                    text: "ä½ å†³å®šæ²¿ç€å°å¾„æ·±å…¥æ£®æ—ã€‚", // é€‰é¡¹æ–‡æœ¬
                    probabilityDisplay: "", // JS ä»£ç ï¼Œè¿”å›æ¦‚ç‡å­—ç¬¦ä¸²
                    functionCall: "", // JS ä»£ç ï¼Œè¿”å› true/false
                    isEnd: false, // æ˜¯å¦ç»“æŸäº‹ä»¶æµ
                    successEventId: "evt_forest_path", // æˆåŠŸåè·³è½¬çš„äº‹ä»¶ ID
                    failureEventId: "", // å¤±è´¥åè·³è½¬çš„äº‹ä»¶ ID
                    resultEffects: [ // ç›´æ¥ç»“æœæ•ˆæœ
                        { type: "change_proficiency", attr: "æ„ŸçŸ¥", amount: 1 }
                    ]
                },
                "opt_forest_leave": {
                    id: "opt_forest_leave",
                    condition: "",
                    title: "ç¦»å¼€",
                    text: "ä½ è§‰å¾—è¿˜æ˜¯ä¸è¦å†’é™©ï¼Œè½¬èº«ç¦»å¼€äº†æ£®æ—è¾¹ç¼˜ã€‚",
                    probabilityDisplay: "",
                    functionCall: "",
                    isEnd: true, // ç»“æŸäº‹ä»¶
                    successEventId: "",
                    failureEventId: "",
                    resultEffects: []
                }
            }
        };
        */

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        // (åœ¨ DOMContentLoaded ä¸­è·å–)
        let eventListContainer, searchInput, filterSelect,
            eventEditorPanel, eventForm, eventIdInput, eventNameInput, eventTypeSelect, eventIsRootCheckbox,
            eventPreconditionsTextarea, eventMutexConditionsTextarea,
            eventTimeInput, eventLocationInput, eventWeatherInput,
            eventVisibleDescTextarea, eventConditionalDescTextarea, eventHiddenDescTextarea,
            eventVisibleCreaturesInput, eventHiddenCreaturesInput, eventMaxGainInput,
            optionsListContainer, addOptionBtn, saveEventBtn, cancelEditBtn, newEventBtn,
            eventPlaceholder,
            optionModal, optionModalCloseBtn, optionModalTitle, optionForm,
            optionIdInput, optionParentEventIdInput, optionTitleInput, optionIsEndCheckbox,
            optionTextTextarea, optionConditionTextarea, optionProbabilityDisplayTextarea,
            optionFunctionCallTextarea, optionSuccessEventIdSelect, optionFailureEventIdSelect,
            optionResultEffectsTextarea, optionModalCancelBtn, optionModalSaveBtn,
            importBtn, exportBtn, importFile;


        // --- è¾…åŠ©å‡½æ•° ---

        /**
         * @description ç”Ÿæˆä¸€ä¸ªç®€å•çš„å”¯ä¸€ ID (ç”¨äºäº‹ä»¶å’Œé€‰é¡¹)
         * @param {string} prefix - ID å‰ç¼€ ('evt_' æˆ– 'opt_')
         * @returns {string} å”¯ä¸€ ID
         */
        function generateUniqueId(prefix) {
            return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2, 7);
        }

        /**
         * @description å®‰å…¨åœ°è§£æ JSON å­—ç¬¦ä¸²
         * @param {string} jsonString - JSON å­—ç¬¦ä¸²
         * @param {*} defaultValue - è§£æå¤±è´¥æ—¶è¿”å›çš„é»˜è®¤å€¼
         * @returns {*} è§£æåçš„å¯¹è±¡æˆ–é»˜è®¤å€¼
         */
        function safeJsonParse(jsonString, defaultValue = null) {
            if (!jsonString || typeof jsonString !== 'string') {
                return defaultValue;
            }
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.warn("JSON è§£æå¤±è´¥:", e, "å­—ç¬¦ä¸²:", jsonString);
                return defaultValue;
            }
        }

        // --- äº‹ä»¶ç®¡ç†é€»è¾‘ ---

        /**
         * @description åˆ›å»ºä¸€ä¸ªæ–°äº‹ä»¶å¯¹è±¡
         * @returns {object} æ–°äº‹ä»¶å¯¹è±¡
         */
        function createNewEventObject() {
            const newId = generateUniqueId('evt_');
            return {
                id: newId,
                name: `æ–°äº‹ä»¶_${newId.substring(4, 8)}`,
                type: "normal",
                isRoot: false,
                preconditions: "",
                mutexConditions: "",
                time: [],
                location: [],
                weather: [],
                visibleDesc: "",
                conditionalDesc: [],
                hiddenDesc: "",
                visibleCreatures: [],
                hiddenCreatures: [],
                maxGain: "",
                options: {}
            };
        }

        /**
         * @description åˆ›å»ºä¸€ä¸ªæ–°é€‰é¡¹å¯¹è±¡
         * @returns {object} æ–°é€‰é¡¹å¯¹è±¡
         */
        function createNewOptionObject() {
            const newId = generateUniqueId('opt_');
            return {
                id: newId,
                condition: "",
                title: "æ–°é€‰é¡¹",
                text: "",
                probabilityDisplay: "",
                functionCall: "",
                isEnd: false,
                successEventId: "",
                failureEventId: "",
                resultEffects: [] // é»˜è®¤ä¸ºç©ºæ•°ç»„
            };
        }

        /**
         * @description ä»è¡¨å•æ•°æ®æ›´æ–°äº‹ä»¶å¯¹è±¡
         * @param {string} eventId - è¦æ›´æ–°çš„äº‹ä»¶ ID
         */
        function updateEventDataFromForm(eventId) {
            const eventData = allEventsData.get(eventId);
            if (!eventData) return;

            eventData.name = eventNameInput.value.trim() || `äº‹ä»¶_${eventId.substring(4, 8)}`;
            eventData.type = eventTypeSelect.value;
            eventData.isRoot = eventIsRootCheckbox.checked;
            eventData.preconditions = eventPreconditionsTextarea.value.trim();
            eventData.mutexConditions = eventMutexConditionsTextarea.value.trim();
            // å¤„ç†é€—å·åˆ†éš”çš„åˆ—è¡¨è¾“å…¥
            eventData.time = eventTimeInput.value.split(',').map(s => s.trim()).filter(Boolean);
            eventData.location = eventLocationInput.value.split(',').map(s => s.trim()).filter(Boolean);
            eventData.weather = eventWeatherInput.value.split(',').map(s => s.trim()).filter(Boolean);
            eventData.visibleDesc = eventVisibleDescTextarea.value.trim();
            // å¤„ç†æ¡ä»¶æè¿°ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
            eventData.conditionalDesc = eventConditionalDescTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
            eventData.hiddenDesc = eventHiddenDescTextarea.value.trim();
            eventData.visibleCreatures = eventVisibleCreaturesInput.value.split(',').map(s => s.trim()).filter(Boolean);
            eventData.hiddenCreatures = eventHiddenCreaturesInput.value.split(',').map(s => s.trim()).filter(Boolean);
            eventData.maxGain = eventMaxGainInput.value.trim();
            // options é€šè¿‡é€‰é¡¹æ¨¡æ€æ¡†å•ç‹¬å¤„ç†
        }

        /**
         * @description ä»é€‰é¡¹è¡¨å•æ•°æ®æ›´æ–°é€‰é¡¹å¯¹è±¡
         * @param {string} eventId - é€‰é¡¹æ‰€å±äº‹ä»¶çš„ ID
         * @param {string} optionId - è¦æ›´æ–°çš„é€‰é¡¹ ID
         */
        function updateOptionDataFromForm(eventId, optionId) {
            const eventData = allEventsData.get(eventId);
            if (!eventData || !eventData.options[optionId]) return;

            const optionData = eventData.options[optionId];
            optionData.title = optionTitleInput.value.trim() || `é€‰é¡¹_${optionId.substring(4, 8)}`;
            optionData.isEnd = optionIsEndCheckbox.checked;
            optionData.text = optionTextTextarea.value.trim();
            optionData.condition = optionConditionTextarea.value.trim();
            optionData.probabilityDisplay = optionProbabilityDisplayTextarea.value.trim();
            optionData.functionCall = optionFunctionCallTextarea.value.trim();
            optionData.successEventId = optionSuccessEventIdSelect.value;
            optionData.failureEventId = optionFailureEventIdSelect.value;
            // è§£æç»“æœæ•ˆæœ JSON
            optionData.resultEffects = safeJsonParse(optionResultEffectsTextarea.value.trim(), []);
            if (!Array.isArray(optionData.resultEffects)) {
                 console.warn(`é€‰é¡¹ ${optionId} çš„ç»“æœæ•ˆæœè§£æå¤±è´¥æˆ–ä¸æ˜¯æ•°ç»„ï¼Œå·²é‡ç½®ä¸ºç©ºæ•°ç»„ã€‚`);
                 optionData.resultEffects = [];
                 optionResultEffectsTextarea.value = '[]'; // æ›´æ–°è¾“å…¥æ¡†
                 alert("ç»“æœæ•ˆæœæ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ•°ç»„ï¼å·²é‡ç½®ä¸ºç©ºæ•°ç»„ã€‚");
            }
        }


        // --- æ¸²æŸ“é€»è¾‘ ---

        /**
         * @description æ¸²æŸ“å·¦ä¾§äº‹ä»¶åˆ—è¡¨
         */
        function renderEventList() {
            eventListContainer.innerHTML = ''; // æ¸…ç©º
            const searchTermLower = currentSearchTerm.toLowerCase();

            // ç­›é€‰å’Œæ’åºäº‹ä»¶
            const filteredEvents = Array.from(allEventsData.values()).filter(event => {
                // åº”ç”¨åç§°æœç´¢
                if (searchTermLower && !event.name.toLowerCase().includes(searchTermLower)) {
                    return false;
                }
                // åº”ç”¨ç±»å‹è¿‡æ»¤
                if (currentEventFilter === 'root' && !event.isRoot) {
                    return false;
                }
                if (currentEventFilter === 'common' && event.type !== 'common') {
                    return false;
                }
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name)); // æŒ‰åç§°æ’åº

            if (filteredEvents.length === 0) {
                eventListContainer.innerHTML = '<p class="p-4 text-gray-500 italic">æ²¡æœ‰åŒ¹é…çš„äº‹ä»¶</p>';
                return;
            }

            // åˆ›å»ºåˆ—è¡¨é¡¹
            filteredEvents.forEach(event => {
                const item = document.createElement('div');
                item.classList.add('event-list-item');
                item.dataset.eventId = event.id;
                if (event.id === currentEditingEventId) {
                    item.classList.add('selected'); // é«˜äº®å½“å‰é€‰ä¸­çš„äº‹ä»¶
                }

                item.innerHTML = `
                    <span class="event-name" title="${event.name} (${event.id})">${event.name} ${event.isRoot ? 'ğŸŒ³' : ''} ${event.type === 'common' ? 'âš™ï¸' : ''} ${event.type === 'combat' ? 'âš”ï¸' : ''}</span>
                    <div class="event-actions">
                        <button class="btn btn-warning btn-sm edit-event-btn" data-event-id="${event.id}">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm delete-event-btn" data-event-id="${event.id}">åˆ é™¤</button>
                    </div>
                `;
                eventListContainer.appendChild(item);
            });

            // ç»‘å®šäº‹ä»¶ç›‘å¬ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
            eventListContainer.removeEventListener('click', handleEventListClick); // ç§»é™¤æ—§ç›‘å¬å™¨
            eventListContainer.addEventListener('click', handleEventListClick);
        }

        /**
         * @description æ¸²æŸ“å³ä¾§äº‹ä»¶ç¼–è¾‘å™¨
         * @param {string | null} eventId - è¦åŠ è½½çš„äº‹ä»¶ IDï¼Œå¦‚æœä¸º null åˆ™æ¸…ç©ºè¡¨å•
         */
        function renderEventEditor(eventId) {
            currentEditingEventId = eventId;

            if (!eventId || !allEventsData.has(eventId)) {
                // æ¸…ç©ºæˆ–éšè—ç¼–è¾‘å™¨ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                eventEditorPanel.style.display = 'none';
                eventPlaceholder.style.display = 'flex';
                renderEventList(); // æ›´æ–°åˆ—è¡¨é«˜äº®
                return;
            }

            eventPlaceholder.style.display = 'none';
            eventEditorPanel.style.display = 'block';
            eventForm.reset(); // é‡ç½®è¡¨å•

            const eventData = allEventsData.get(eventId);

            // å¡«å……è¡¨å•å­—æ®µ
            eventIdInput.value = eventData.id;
            eventNameInput.value = eventData.name;
            eventTypeSelect.value = eventData.type;
            eventIsRootCheckbox.checked = eventData.isRoot;
            eventPreconditionsTextarea.value = eventData.preconditions || "";
            eventMutexConditionsTextarea.value = eventData.mutexConditions || "";
            eventTimeInput.value = (eventData.time || []).join(',');
            eventLocationInput.value = (eventData.location || []).join(',');
            eventWeatherInput.value = (eventData.weather || []).join(',');
            eventVisibleDescTextarea.value = eventData.visibleDesc || "";
            eventConditionalDescTextarea.value = (eventData.conditionalDesc || []).join('\n');
            eventHiddenDescTextarea.value = eventData.hiddenDesc || "";
            eventVisibleCreaturesInput.value = (eventData.visibleCreatures || []).join(',');
            eventHiddenCreaturesInput.value = (eventData.hiddenCreatures || []).join(',');
            eventMaxGainInput.value = eventData.maxGain || "";

            // æ¸²æŸ“é€‰é¡¹åˆ—è¡¨
            renderOptionsList(eventId);

            // æ›´æ–°å·¦ä¾§åˆ—è¡¨é«˜äº®
            renderEventList();
        }

        /**
         * @description æ¸²æŸ“æŒ‡å®šäº‹ä»¶çš„é€‰é¡¹åˆ—è¡¨
         * @param {string} eventId - äº‹ä»¶ ID
         */
        function renderOptionsList(eventId) {
            optionsListContainer.innerHTML = ''; // æ¸…ç©º
            const eventData = allEventsData.get(eventId);
            if (!eventData || Object.keys(eventData.options).length === 0) {
                optionsListContainer.innerHTML = '<p class="text-gray-500 italic">æš‚æ— é€‰é¡¹</p>';
                return;
            }

            Object.values(eventData.options).forEach(option => {
                const item = document.createElement('div');
                item.classList.add('option-item');
                item.dataset.optionId = option.id;

                // æŸ¥æ‰¾è·³è½¬äº‹ä»¶çš„åç§°
                const successEventName = allEventsData.get(option.successEventId)?.name || 'æ— ';
                const failureEventName = allEventsData.get(option.failureEventId)?.name || 'æ— ';

                item.innerHTML = `
                    <h4>
                        <span>${option.title}</span>
                        <span class="option-id">ID: ${option.id}</span>
                        <div>
                            <button class="btn btn-warning btn-sm edit-option-btn" data-event-id="${eventId}" data-option-id="${option.id}">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm delete-option-btn" data-event-id="${eventId}" data-option-id="${option.id}">åˆ é™¤</button>
                        </div>
                    </h4>
                    <div class="option-details">
                        <p><strong>æ–‡æœ¬:</strong> ${option.text || 'æ— '}</p>
                        ${option.condition ? `<p><strong>æ¡ä»¶:</strong> <code>${option.condition}</code></p>` : ''}
                        ${option.probabilityDisplay ? `<p><strong>æ¦‚ç‡æ˜¾ç¤º:</strong> <code>${option.probabilityDisplay}</code></p>` : ''}
                        ${option.functionCall ? `<p><strong>è°ƒç”¨å‡½æ•°:</strong> <code>${option.functionCall}</code></p>` : ''}
                        <p><strong>ç»“æŸäº‹ä»¶:</strong> ${option.isEnd ? 'æ˜¯' : 'å¦'}</p>
                        <p><strong>æˆåŠŸè·³è½¬:</strong> ${successEventName} (${option.successEventId || 'æ— '})</p>
                        <p><strong>å¤±è´¥è·³è½¬:</strong> ${failureEventName} (${option.failureEventId || 'æ— '})</p>
                        <p><strong>ç»“æœæ•ˆæœ:</strong> <code>${JSON.stringify(option.resultEffects)}</code></p>
                    </div>
                `;
                optionsListContainer.appendChild(item);
            });

            // ç»‘å®šé€‰é¡¹æŒ‰é’®äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
            optionsListContainer.removeEventListener('click', handleOptionButtonClick);
            optionsListContainer.addEventListener('click', handleOptionButtonClick);
        }

        /**
         * @description å¡«å……é€‰é¡¹æ¨¡æ€æ¡†ä¸­çš„äº‹ä»¶è·³è½¬ä¸‹æ‹‰åˆ—è¡¨
         */
        function populateEventIdSelects() {
            const successSelect = optionSuccessEventIdSelect;
            const failureSelect = optionFailureEventIdSelect;
            const currentSuccessValue = successSelect.value; // ä¿å­˜å½“å‰å€¼
            const currentFailureValue = failureSelect.value;

            successSelect.innerHTML = '<option value="">-- æ— è·³è½¬ --</option>';
            failureSelect.innerHTML = '<option value="">-- æ— è·³è½¬ --</option>';

            // æ·»åŠ ä¸€ä¸ªâ€œæ­»äº¡äº‹ä»¶â€çš„é€šç”¨é€‰é¡¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const deathEvent = Array.from(allEventsData.values()).find(e => e.name === 'æ­»äº¡äº‹ä»¶' && e.type === 'common');
            if (deathEvent) {
                 const deathOption = document.createElement('option');
                 deathOption.value = deathEvent.id;
                 deathOption.textContent = `[å…¬å…±] æ­»äº¡äº‹ä»¶ (${deathEvent.id})`;
                 successSelect.appendChild(deathOption.cloneNode(true));
                 failureSelect.appendChild(deathOption);
            }


            // æ·»åŠ æ‰€æœ‰äº‹ä»¶ä½œä¸ºé€‰é¡¹
            Array.from(allEventsData.values())
                .sort((a, b) => a.name.localeCompare(b.name)) // æŒ‰åç§°æ’åº
                .forEach(event => {
                    // ä¸å…è®¸è·³è½¬åˆ°è‡ªèº«
                    if (event.id === currentEditingEventId) return;

                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} (${event.id})${event.isRoot ? 'ğŸŒ³' : ''}${event.type === 'common' ? 'âš™ï¸' : ''}${event.type === 'combat' ? 'âš”ï¸' : ''}`;
                    successSelect.appendChild(option.cloneNode(true));
                    failureSelect.appendChild(option);
                });

            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
            successSelect.value = currentSuccessValue;
            failureSelect.value = currentFailureValue;
        }

        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---

        /**
         * @description å¤„ç†å·¦ä¾§äº‹ä»¶åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
         * @param {Event} event
         */
        function handleEventListClick(event) {
            const target = event.target;
            const listItem = target.closest('.event-list-item');
            const editButton = target.closest('.edit-event-btn');
            const deleteButton = target.closest('.delete-event-btn');

            if (editButton) {
                const eventId = editButton.dataset.eventId;
                renderEventEditor(eventId);
            } else if (deleteButton) {
                const eventId = deleteButton.dataset.eventId;
                const eventData = allEventsData.get(eventId);
                if (eventData && confirm(`ç¡®å®šè¦åˆ é™¤äº‹ä»¶ "${eventData.name}" (${eventId}) å—ï¼Ÿ`)) {
                    allEventsData.delete(eventId);
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„äº‹ä»¶ï¼Œåˆ™æ¸…ç©ºç¼–è¾‘å™¨
                    if (currentEditingEventId === eventId) {
                        renderEventEditor(null);
                    }
                    renderEventList(); // åˆ·æ–°åˆ—è¡¨
                    console.log(`äº‹ä»¶ ${eventId} å·²åˆ é™¤`);
                }
            } else if (listItem) {
                // ç‚¹å‡»åˆ—è¡¨é¡¹æœ¬èº«ï¼ŒåŠ è½½åˆ°ç¼–è¾‘å™¨
                const eventId = listItem.dataset.eventId;
                renderEventEditor(eventId);
            }
        }

        /**
         * @description å¤„ç†é€‰é¡¹åˆ—è¡¨ä¸­çš„æŒ‰é’®ç‚¹å‡» (äº‹ä»¶å§”æ‰˜)
         * @param {Event} event
         */
        function handleOptionButtonClick(event) {
            const target = event.target;
            const editButton = target.closest('.edit-option-btn');
            const deleteButton = target.closest('.delete-option-btn');

            if (editButton) {
                const eventId = editButton.dataset.eventId;
                const optionId = editButton.dataset.optionId;
                openOptionModal('edit', eventId, optionId);
            } else if (deleteButton) {
                const eventId = deleteButton.dataset.eventId;
                const optionId = deleteButton.dataset.optionId;
                const eventData = allEventsData.get(eventId);
                if (eventData && eventData.options[optionId] && confirm(`ç¡®å®šè¦åˆ é™¤é€‰é¡¹ "${eventData.options[optionId].title}" (${optionId}) å—ï¼Ÿ`)) {
                    delete eventData.options[optionId];
                    renderOptionsList(eventId); // åˆ·æ–°é€‰é¡¹åˆ—è¡¨
                    console.log(`äº‹ä»¶ ${eventId} ä¸­çš„é€‰é¡¹ ${optionId} å·²åˆ é™¤`);
                }
            }
        }


        /**
         * @description å¤„ç†æ–°å»ºäº‹ä»¶æŒ‰é’®ç‚¹å‡»
         */
        function handleNewEventClick() {
            const newEvent = createNewEventObject();
            allEventsData.set(newEvent.id, newEvent);
            renderEventList(); // åˆ·æ–°åˆ—è¡¨
            renderEventEditor(newEvent.id); // åŠ è½½æ–°äº‹ä»¶åˆ°ç¼–è¾‘å™¨
            console.log(`æ–°äº‹ä»¶ ${newEvent.id} å·²åˆ›å»º`);
        }

        /**
         * @description å¤„ç†æœç´¢æ¡†è¾“å…¥
         */
        function handleSearchInputChange() {
            currentSearchTerm = searchInput.value;
            renderEventList(); // æ ¹æ®æ–°å…³é”®è¯é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        /**
         * @description å¤„ç†ç­›é€‰ä¸‹æ‹‰æ¡†å˜åŒ–
         */
        function handleFilterChange() {
            currentEventFilter = filterSelect.value;
            renderEventList(); // æ ¹æ®æ–°ç­›é€‰æ¡ä»¶é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        /**
         * @description å¤„ç†ä¿å­˜äº‹ä»¶æŒ‰é’®ç‚¹å‡»
         */
        function handleSaveEventClick() {
            if (!currentEditingEventId) return;
            updateEventDataFromForm(currentEditingEventId);
            renderEventList(); // æ›´æ–°åˆ—è¡¨å¯èƒ½å˜åŒ–çš„åç§°æˆ–æ ‡è®°
            alert(`äº‹ä»¶ "${allEventsData.get(currentEditingEventId)?.name}" å·²ä¿å­˜ï¼`);
            console.log(`äº‹ä»¶ ${currentEditingEventId} å·²ä¿å­˜`);
        }

        /**
         * @description å¤„ç†å–æ¶ˆç¼–è¾‘æŒ‰é’®ç‚¹å‡»
         */
        function handleCancelEditClick() {
            renderEventEditor(null); // æ¸…ç©ºç¼–è¾‘å™¨
        }

        /**
         * @description å¤„ç†æ·»åŠ é€‰é¡¹æŒ‰é’®ç‚¹å‡»
         */
        function handleAddOptionClick() {
            if (!currentEditingEventId) {
                alert("è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªäº‹ä»¶ï¼");
                return;
            }
            openOptionModal('add', currentEditingEventId);
        }

        /**
         * @description å¤„ç†é€‰é¡¹æ¨¡æ€æ¡†ä¿å­˜æŒ‰é’®ç‚¹å‡»
         * @param {Event} event
         */
        function handleOptionModalSave(event) {
            event.preventDefault(); // é˜»æ­¢è¡¨å•æäº¤
            const eventId = optionParentEventIdInput.value;
            const optionId = optionIdInput.value; // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¿™é‡Œæœ‰å€¼

            if (!eventId || !allEventsData.has(eventId)) {
                alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°çˆ¶äº‹ä»¶ï¼");
                return;
            }

            if (currentEditingOptionId) {
                // ç¼–è¾‘æ¨¡å¼
                updateOptionDataFromForm(eventId, currentEditingOptionId);
                console.log(`äº‹ä»¶ ${eventId} ä¸­çš„é€‰é¡¹ ${currentEditingOptionId} å·²æ›´æ–°`);
            } else {
                // æ–°å¢æ¨¡å¼
                const newOption = createNewOptionObject();
                allEventsData.get(eventId).options[newOption.id] = newOption;
                updateOptionDataFromForm(eventId, newOption.id); // ç”¨è¡¨å•æ•°æ®å¡«å……æ–°é€‰é¡¹
                console.log(`äº‹ä»¶ ${eventId} ä¸­å·²æ·»åŠ æ–°é€‰é¡¹ ${newOption.id}`);
            }

            renderOptionsList(eventId); // åˆ·æ–°å³ä¾§é€‰é¡¹åˆ—è¡¨
            closeOptionModal();
        }

        /**
         * @description å¤„ç†å¯¼å…¥æŒ‰é’®ç‚¹å‡»
         */
        function handleImportClick() {
            importFile.click();
        }

        /**
         * @description å¤„ç†å¯¼å…¥æ–‡ä»¶é€‰æ‹©
         * @param {Event} event
         */
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // ç®€å•éªŒè¯æ˜¯å¦æ˜¯ Map çš„åºåˆ—åŒ–å½¢å¼ (æ•°ç»„å¥—æ•°ç»„)
                    if (Array.isArray(importedData) && importedData.every(item => Array.isArray(item) && item.length === 2 && typeof item[0] === 'string')) {
                        allEventsData = new Map(importedData);
                        currentEditingEventId = null; // æ¸…ç©ºå½“å‰ç¼–è¾‘
                        renderEventList();
                        renderEventEditor(null); // æ¸…ç©ºç¼–è¾‘å™¨
                        alert(`æˆåŠŸå¯¼å…¥ ${allEventsData.size} ä¸ªäº‹ä»¶ï¼`);
                        console.log("äº‹ä»¶æ•°æ®å·²å¯¼å…¥");
                    } else {
                        throw new Error("æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼ŒæœŸæœ›æ˜¯ Map çš„ JSON åºåˆ—åŒ–æ ¼å¼ã€‚");
                    }
                } catch (error) {
                    console.error("å¯¼å…¥äº‹ä»¶å¤±è´¥:", error);
                    alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                } finally {
                    importFile.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                }
            };
            reader.readAsText(file);
        }

        /**
         * @description å¤„ç†å¯¼å‡ºæŒ‰é’®ç‚¹å‡»
         */
        function handleExportClick() {
            if (allEventsData.size === 0) {
                alert("æ²¡æœ‰äº‹ä»¶å¯ä»¥å¯¼å‡ºï¼");
                return;
            }
            try {
                // å°† Map è½¬æ¢ä¸ºæ•°ç»„å†åºåˆ—åŒ–
                const dataToExport = JSON.stringify(Array.from(allEventsData.entries()), null, 2); // æ ¼å¼åŒ–è¾“å‡º
                const blob = new Blob([dataToExport], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'game_events_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                console.log("äº‹ä»¶æ•°æ®å·²å¯¼å‡º");
            } catch (error) {
                console.error("å¯¼å‡ºäº‹ä»¶å¤±è´¥:", error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }


        // --- æ¨¡æ€æ¡†æ§åˆ¶ ---

        /**
         * @description æ‰“å¼€é€‰é¡¹ç¼–è¾‘/æ–°å¢æ¨¡æ€æ¡†
         * @param {'add' | 'edit'} mode - æ¨¡å¼
         * @param {string} eventId - çˆ¶äº‹ä»¶ ID
         * @param {string | null} [optionId=null] - å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¼ å…¥é€‰é¡¹ ID
         */
        function openOptionModal(mode, eventId, optionId = null) {
            optionForm.reset(); // é‡ç½®è¡¨å•
            currentEditingOptionId = null; // é‡ç½®ç¼–è¾‘çŠ¶æ€

            const eventData = allEventsData.get(eventId);
            if (!eventData) return;

            optionParentEventIdInput.value = eventId; // è®¾ç½®éšè—çš„çˆ¶äº‹ä»¶ ID

            // å¡«å……äº‹ä»¶è·³è½¬ä¸‹æ‹‰åˆ—è¡¨
            populateEventIdSelects();

            if (mode === 'edit' && optionId && eventData.options[optionId]) {
                // ç¼–è¾‘æ¨¡å¼
                currentEditingOptionId = optionId;
                const optionData = eventData.options[optionId];
                optionModalTitle.textContent = `ç¼–è¾‘é€‰é¡¹ (${optionId})`;
                optionIdInput.value = optionId; // è®¾ç½®éšè—çš„é€‰é¡¹ ID
                optionTitleInput.value = optionData.title;
                optionIsEndCheckbox.checked = optionData.isEnd;
                optionTextTextarea.value = optionData.text;
                optionConditionTextarea.value = optionData.condition || "";
                optionProbabilityDisplayTextarea.value = optionData.probabilityDisplay || "";
                optionFunctionCallTextarea.value = optionData.functionCall || "";
                optionSuccessEventIdSelect.value = optionData.successEventId || "";
                optionFailureEventIdSelect.value = optionData.failureEventId || "";
                optionResultEffectsTextarea.value = JSON.stringify(optionData.resultEffects || [], null, 2); // æ ¼å¼åŒ–æ˜¾ç¤º

            } else {
                // æ–°å¢æ¨¡å¼
                optionModalTitle.textContent = `ä¸ºäº‹ä»¶ "${eventData.name}" æ·»åŠ æ–°é€‰é¡¹`;
                optionIdInput.value = ""; // æ¸…ç©ºé€‰é¡¹ ID
                optionResultEffectsTextarea.value = '[]'; // é»˜è®¤ç©ºæ•°ç»„
            }

            optionModal.style.display = 'flex';
        }

        /**
         * @description å…³é—­é€‰é¡¹ç¼–è¾‘/æ–°å¢æ¨¡æ€æ¡†
         */
        function closeOptionModal() {
            optionModal.style.display = 'none';
            currentEditingOptionId = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
        }


        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Initializing Event Manager...");

            // è·å– DOM å¼•ç”¨
            eventListContainer = document.getElementById('event-list');
            searchInput = document.getElementById('search-event-input');
            filterSelect = document.getElementById('filter-event-select');
            eventEditorPanel = document.getElementById('event-editor-panel');
            eventForm = document.getElementById('event-form');
            eventIdInput = document.getElementById('event-id');
            eventNameInput = document.getElementById('event-name');
            eventTypeSelect = document.getElementById('event-type');
            eventIsRootCheckbox = document.getElementById('event-is-root');
            eventPreconditionsTextarea = document.getElementById('event-preconditions');
            eventMutexConditionsTextarea = document.getElementById('event-mutex-conditions');
            eventTimeInput = document.getElementById('event-time');
            eventLocationInput = document.getElementById('event-location');
            eventWeatherInput = document.getElementById('event-weather');
            eventVisibleDescTextarea = document.getElementById('event-visible-desc');
            eventConditionalDescTextarea = document.getElementById('event-conditional-desc');
            eventHiddenDescTextarea = document.getElementById('event-hidden-desc');
            eventVisibleCreaturesInput = document.getElementById('event-visible-creatures');
            eventHiddenCreaturesInput = document.getElementById('event-hidden-creatures');
            eventMaxGainInput = document.getElementById('event-max-gain');
            optionsListContainer = document.getElementById('options-list');
            addOptionBtn = document.getElementById('add-option-btn');
            saveEventBtn = document.getElementById('save-event-btn');
            cancelEditBtn = document.getElementById('cancel-edit-btn');
            newEventBtn = document.getElementById('new-event-btn');
            eventPlaceholder = document.getElementById('event-placeholder');
            optionModal = document.getElementById('option-modal');
            optionModalCloseBtn = document.getElementById('option-modal-close-btn');
            optionModalTitle = document.getElementById('option-modal-title');
            optionForm = document.getElementById('option-form');
            optionIdInput = document.getElementById('option-id');
            optionParentEventIdInput = document.getElementById('option-parent-event-id');
            optionTitleInput = document.getElementById('option-title');
            optionIsEndCheckbox = document.getElementById('option-is-end');
            optionTextTextarea = document.getElementById('option-text');
            optionConditionTextarea = document.getElementById('option-condition');
            optionProbabilityDisplayTextarea = document.getElementById('option-probability-display');
            optionFunctionCallTextarea = document.getElementById('option-function-call');
            optionSuccessEventIdSelect = document.getElementById('option-success-event-id');
            optionFailureEventIdSelect = document.getElementById('option-failure-event-id');
            optionResultEffectsTextarea = document.getElementById('option-result-effects');
            optionModalCancelBtn = document.getElementById('option-modal-cancel-btn');
            optionModalSaveBtn = document.getElementById('option-modal-save-btn');
            importBtn = document.getElementById('import-events-btn');
            exportBtn = document.getElementById('export-events-btn');
            importFile = document.getElementById('import-events-file');


            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            newEventBtn.addEventListener('click', handleNewEventClick);
            searchInput.addEventListener('input', handleSearchInputChange);
            filterSelect.addEventListener('change', handleFilterChange);
            saveEventBtn.addEventListener('click', handleSaveEventClick);
            cancelEditBtn.addEventListener('click', handleCancelEditClick);
            addOptionBtn.addEventListener('click', handleAddOptionClick);
            optionModalCloseBtn.addEventListener('click', closeOptionModal);
            optionModalCancelBtn.addEventListener('click', closeOptionModal);
            optionForm.addEventListener('submit', handleOptionModalSave);
            importBtn.addEventListener('click', handleImportClick);
            importFile.addEventListener('change', handleImportFile);
            exportBtn.addEventListener('click', handleExportClick);

            // åˆå§‹åŠ è½½/æ¸²æŸ“
            // TODO: å¯ä»¥å°è¯•ä» localStorage åŠ è½½æ•°æ®
            renderEventList(); // åˆå§‹æ¸²æŸ“ç©ºåˆ—è¡¨æˆ–åŠ è½½çš„æ•°æ®
            renderEventEditor(null); // åˆå§‹éšè—ç¼–è¾‘å™¨

            console.log("Event Manager Initialized.");

             // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ® (å¯é€‰)
             /*
             const evt1 = createNewEventObject();
             evt1.name = "æ£®æ—å…¥å£";
             evt1.isRoot = true;
             evt1.visibleDesc = "ä½ ç«™åœ¨ä¸€ç‰‡èŒ‚å¯†çš„æ£®æ—è¾¹ç¼˜...";
             const opt1_1 = createNewOptionObject();
             opt1_1.title = "è¿›å…¥æ£®æ—";
             opt1_1.text = "ä½ å†³å®šæ·±å…¥...";
             opt1_1.successEventId = "evt_placeholder_path"; // æŒ‡å‘ä¸€ä¸ªå°šä¸å­˜åœ¨çš„äº‹ä»¶
             evt1.options[opt1_1.id] = opt1_1;
             const opt1_2 = createNewOptionObject();
             opt1_2.title = "ç¦»å¼€";
             opt1_2.text = "ä½ è½¬èº«ç¦»å¼€...";
             opt1_2.isEnd = true;
             evt1.options[opt1_2.id] = opt1_2;
             allEventsData.set(evt1.id, evt1);

             const evt_death = createNewEventObject();
             evt_death.name = "æ­»äº¡äº‹ä»¶";
             evt_death.type = "common";
             evt_death.visibleDesc = "ä½ æ­»äº†...";
             const opt_death_end = createNewOptionObject();
             opt_death_end.title = "ç»“æŸæ¸¸æˆ";
             opt_death_end.isEnd = true;
             evt_death.options[opt_death_end.id] = opt_death_end;
             allEventsData.set(evt_death.id, evt_death);

             renderEventList();
             */

        });

    </script>

</body>
</html>
